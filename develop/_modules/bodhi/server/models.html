
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bodhi.server.models &#8212; bodhi 7.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bodhi.server.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright Â© 2011-2019 Red Hat, Inc. and others.</span>
<span class="c1"># This file is part of Bodhi.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU General Public License</span>
<span class="c1"># as published by the Free Software Foundation; either version 2</span>
<span class="c1"># of the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program; if not, write to the Free Software</span>
<span class="c1"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="sd">&quot;&quot;&quot;Bodhi&#39;s database models.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">wrap</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">mediawiki</span> <span class="kn">import</span> <span class="n">MediaWiki</span>
<span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">parse_version</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">sqlalchemy_version</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">and_</span><span class="p">,</span>
    <span class="n">Boolean</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">Date</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">event</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">or_</span><span class="p">,</span>
    <span class="n">Table</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
    <span class="n">UnicodeText</span><span class="p">,</span>
    <span class="n">UniqueConstraint</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">backref</span><span class="p">,</span> <span class="n">class_mapper</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">validates</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.base</span> <span class="kn">import</span> <span class="n">NEVER_SET</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="kn">import</span> <span class="n">NoResultFound</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.properties</span> <span class="kn">import</span> <span class="n">RelationshipProperty</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">SchemaType</span><span class="p">,</span> <span class="n">TypeDecorator</span>
<span class="kn">import</span> <span class="nn">requests.exceptions</span>
<span class="kn">import</span> <span class="nn">rpm</span>

<span class="kn">from</span> <span class="nn">bodhi.messages.schemas</span> <span class="kn">import</span> <span class="n">buildroot_override</span> <span class="k">as</span> <span class="n">override_schemas</span>
<span class="kn">from</span> <span class="nn">bodhi.messages.schemas</span> <span class="kn">import</span> <span class="n">errata</span> <span class="k">as</span> <span class="n">errata_schemas</span>
<span class="kn">from</span> <span class="nn">bodhi.messages.schemas</span> <span class="kn">import</span> <span class="n">update</span> <span class="k">as</span> <span class="n">update_schemas</span>
<span class="kn">from</span> <span class="nn">bodhi.server</span> <span class="kn">import</span> <span class="n">bugs</span><span class="p">,</span> <span class="n">buildsys</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">mail</span><span class="p">,</span> <span class="n">notifications</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">bodhi.server.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">bodhi.server.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BodhiException</span><span class="p">,</span>
    <span class="n">ExternalCallException</span><span class="p">,</span>
    <span class="n">LockedUpdateException</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bodhi.server.tasks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">fetch_test_cases_task</span><span class="p">,</span>
    <span class="n">tag_update_builds_task</span><span class="p">,</span>
    <span class="n">work_on_bugs_task</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bodhi.server.util</span> <span class="kn">import</span> <span class="n">avatar</span> <span class="k">as</span> <span class="n">get_avatar</span>
<span class="kn">from</span> <span class="nn">bodhi.server.util</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">build_evr</span><span class="p">,</span>
    <span class="n">get_critpath_components</span><span class="p">,</span>
    <span class="n">get_grouped_critpath_components</span><span class="p">,</span>
    <span class="n">get_rpm_header</span><span class="p">,</span>
    <span class="n">header</span><span class="p">,</span>
    <span class="n">pagure_api_get</span><span class="p">,</span>
    <span class="n">tokenize</span><span class="p">,</span>
    <span class="n">build_names_by_type</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">import</span> <span class="nn">bugzilla</span>  <span class="c1"># noqa: 401</span>
    <span class="kn">import</span> <span class="nn">pyramid</span>  <span class="c1"># noqa: 401</span>


<span class="c1"># http://techspot.zzzeek.org/2011/01/14/the-enum-recipe</span>

<div class="viewcode-block" id="EnumSymbol"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol">[docs]</a><span class="k">class</span> <span class="nc">EnumSymbol</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define a fixed symbol tied to a parent class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnumSymbol.__init__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the EnumSymbol.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls_ (EnumMeta): The metaclass this symbol is tied to.</span>
<span class="sd">            name (str): The name of this symbol.</span>
<span class="sd">            value (str): The value used in the database to represent this symbol.</span>
<span class="sd">            description (str): A human readable description of this symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_</span> <span class="o">=</span> <span class="n">cls_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span></div>

<div class="viewcode-block" id="EnumSymbol.__lt__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol.__lt__">[docs]</a>    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if self.value is less than other.value.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (EnumSymbol): The other EnumSymbol we are being compared to.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if self.value is less than other.value, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="EnumSymbol.__reduce__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol.__reduce__">[docs]</a>    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow unpickling to return the symbol linked to the DeclEnum class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 2-tuple of the ``getattr`` function, and a 2-tuple of the EnumSymbol&#39;s member</span>
<span class="sd">            class and name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnumSymbol.__iter__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol.__iter__">[docs]</a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate over this EnumSymbol&#39;s value and description.</span>

<span class="sd">        Returns:</span>
<span class="sd">            iterator: An iterator over the value and description.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">])</span></div>

<div class="viewcode-block" id="EnumSymbol.__repr__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation of this EnumSymbol.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of this EnumSymbol&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="EnumSymbol.__str__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation of this EnumSymbol.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A string representation of this EnumSymbol&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnumSymbol.__json__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumSymbol.__json__">[docs]</a>    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON representation of this EnumSymbol.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (pyramid.request.Request): The current request.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of this EnumSymbol&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div></div>


<div class="viewcode-block" id="EnumMeta"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumMeta">[docs]</a><span class="k">class</span> <span class="nc">EnumMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate new DeclEnum classes.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnumMeta.__init__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumMeta.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the metaclass.</span>

<span class="sd">        Args:</span>
<span class="sd">            classname (str): The name of the enum.</span>
<span class="sd">            bases (list): A list of base classes for the enum.</span>
<span class="sd">            dict_ (dict): A key-value mapping for the new enum&#39;s attributes.</span>
<span class="sd">        Returns:</span>
<span class="sd">            DeclEnum: A new DeclEnum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_reg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">EnumSymbol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnumMeta.__iter__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.EnumMeta.__iter__">[docs]</a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate the enum values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            iterator: An iterator for the enum values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_reg</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="DeclEnum"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnum">[docs]</a><span class="k">class</span> <span class="nc">DeclEnum</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">EnumMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Declarative enumeration.&quot;&quot;&quot;</span>

    <span class="n">_reg</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="DeclEnum.from_string"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnum.from_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a string version of the enum to its enum type.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (str): A string that you wish to convert to an Enum value.</span>
<span class="sd">        Returns:</span>
<span class="sd">            EnumSymbol: The symbol corresponding to the value.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If no symbol matches the given value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_reg</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for </span><span class="si">%r</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="DeclEnum.values"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnum.values">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the possible values that this enum can take on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of strings of the values that this enum can represent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_reg</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="DeclEnum.db_type"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnum.db_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">db_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a database column type to be used for this enum.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DeclEnumType: A DeclEnumType to be used for this enum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DeclEnumType</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DeclEnumType"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnumType">[docs]</a><span class="k">class</span> <span class="nc">DeclEnumType</span><span class="p">(</span><span class="n">SchemaType</span><span class="p">,</span> <span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A database column type for an enum.&quot;&quot;&quot;</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See ``sqlalchemy.types.TypeDecorator.cache_ok``&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DeclEnumType.__init__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnumType.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize with the given enum.</span>

<span class="sd">        Args:</span>
<span class="sd">            enum (bodhi.server.models.EnumMeta): The enum metaclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enum</span> <span class="o">=</span> <span class="n">enum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span>
            <span class="o">*</span><span class="n">enum</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ck</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;([A-Z])&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">enum</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
            <span class="c1"># Required for SQLAlchemy &gt;= 1.3.8</span>
            <span class="c1"># https://docs.sqlalchemy.org/en/14/changelog/changelog_13.html#change-ac119f6307026142f7a0ccbf81065f25</span>
            <span class="n">sort_key_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the table for this object.</span>

<span class="sd">        Args:</span>
<span class="sd">            table (sqlalchemy.sql.schema.Table): The table that uses this Enum.</span>
<span class="sd">            column (sqlalchemy.sql.schema.Column): The column that uses this Enum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">_set_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>

<div class="viewcode-block" id="DeclEnumType.copy"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnumType.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a copy of self.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DeclEnumType: A copy of self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DeclEnumType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enum</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeclEnumType.process_bind_param"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnumType.process_bind_param">[docs]</a>    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the enum.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bodhi.server.models.enum.EnumSymbol): The enum symbol we are resolving the value</span>
<span class="sd">                of.</span>
<span class="sd">            dialect (sqlalchemy.engine.default.DefaultDialect): Unused.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The EnumSymbol&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="DeclEnumType.process_result_value"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnumType.process_result_value">[docs]</a>    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the enum that matches the given string.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (str): The name of an enum.</span>
<span class="sd">            dialect (sqlalchemy.engine.default.DefaultDialect): Unused.</span>
<span class="sd">        Returns:</span>
<span class="sd">            EnumSymbol or None: The enum that matches value, or ``None`` if ``value`` is ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>

<div class="viewcode-block" id="DeclEnumType.create"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnumType.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Issue CREATE ddl for this type, if applicable.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeclEnumType</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect_impl</span><span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">SchemaType</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeclEnumType.drop"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.DeclEnumType.drop">[docs]</a>    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Issue DROP ddl for this type, if applicable.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeclEnumType</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect_impl</span><span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">SchemaType</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BodhiBase"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BodhiBase">[docs]</a><span class="k">class</span> <span class="nc">BodhiBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for the SQLAlchemy model base class.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        __exclude_columns__ (tuple): A list of columns to exclude from JSON</span>
<span class="sd">        __include_extras__ (tuple): A list of methods or attrs to include in JSON</span>
<span class="sd">        __get_by__ (tuple): A list of columns that :meth:`.get` will query.</span>
<span class="sd">        id (int): An integer id that serves as the default primary key.</span>
<span class="sd">        query (sqlalchemy.orm.query.Query): a class property which produces a</span>
<span class="sd">            Query object against the class and the current Session when called.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,)</span>
    <span class="n">__include_extras__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query_property</span><span class="p">()</span>

<div class="viewcode-block" id="BodhiBase.get"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BodhiBase.get">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of the model by using its __get_by__ attribute with id.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (object): An attribute to look up the model by.</span>
<span class="sd">        Returns:</span>
<span class="sd">            BodhiBase or None: An instance of the model that matches the id, or ``None`` if no match</span>
<span class="sd">            was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_by__</span>
        <span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

<div class="viewcode-block" id="BodhiBase.__getitem__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BodhiBase.__getitem__">[docs]</a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define a dictionary like interface for the models.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (string): The name of an attribute you wish to retrieve from the model.</span>
<span class="sd">        Returns:</span>
<span class="sd">            object: The value of the attribute represented by key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="BodhiBase.__repr__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BodhiBase.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation of this model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__json__</span><span class="p">())</span></div>

<div class="viewcode-block" id="BodhiBase.__json__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BodhiBase.__json__">[docs]</a>    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON representation of this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (pyramid.request.Request or None): The current web request, or None.</span>
<span class="sd">            exclude (iterable or None): An iterable of strings naming the attributes to exclude from</span>
<span class="sd">                the JSON representation of the model. If None (the default), the class&#39;s</span>
<span class="sd">                __exclude_columns__ attribute will be used.</span>
<span class="sd">            include (iterable or None): An iterable of strings naming the extra attributes to</span>
<span class="sd">                include in the JSON representation of the model. If None (the default), the class&#39;s</span>
<span class="sd">                __include_extras__ attribute will be used.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: A dict representation of the model suitable for serialization as JSON.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_to_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON representation of obj.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (BodhiBase): The model to serialize.</span>
<span class="sd">            seen (list or None): A list of attributes we have already serialized. Used by this</span>
<span class="sd">                method to keep track of its state, as it uses recursion.</span>
<span class="sd">            request (pyramid.request.Request or None): The current web request, or None.</span>
<span class="sd">            exclude (iterable or None): An iterable of strings naming the attributes to exclude from</span>
<span class="sd">                the JSON representation of the model. If None (the default), the class&#39;s</span>
<span class="sd">                __exclude_columns__ attribute will be used.</span>
<span class="sd">            include (iterable or None): An iterable of strings naming the extra attributes to</span>
<span class="sd">                include in the JSON representation of the model. If None (the default), the class&#39;s</span>
<span class="sd">                __include_extras__ attribute will be used.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: A dict representation of the model suitable for serialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__exclude_columns__&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">class_mapper</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span><span class="o">.</span><span class="n">iterate_properties</span><span class="p">)</span>
        <span class="n">rels</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">)]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span>
                  <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__include_extras__&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">attribute</span><span class="p">):</span>
                <span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">d</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">seen</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">EnumSymbol</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the to_json or id of a sqlalchemy relationship.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (BodhiBase): The object we are trying to describe a relationship on.</span>
<span class="sd">            relation (object): A relationship attribute on obj we are trying to learn about.</span>
<span class="sd">            seen (list): A list of objects we have already recursed over.</span>
<span class="sd">            req (pyramid.request.Request): The current request.</span>
<span class="sd">        Returns:</span>
<span class="sd">            object: The to_json() or the id of a sqlalchemy relationship.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">relation</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_to_json</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">seen</span> <span class="o">+</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)],</span> <span class="n">req</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">relation</span><span class="o">.</span><span class="n">id</span>

<div class="viewcode-block" id="BodhiBase.grid_columns"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BodhiBase.grid_columns">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">grid_columns</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the column names for the model, except for the excluded ones.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of column names, with excluded ones removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__exclude_columns__&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">columns</span></div>

<div class="viewcode-block" id="BodhiBase.find_polymorphic_child"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BodhiBase.find_polymorphic_child">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">find_polymorphic_child</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identity</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find a child of a polymorphic base class.</span>

<span class="sd">        For example, given the base Package class and the &#39;rpm&#39; identity, this</span>
<span class="sd">        class method should return the RpmPackage class.</span>

<span class="sd">        This is accomplished by iterating over all classes in scope.</span>
<span class="sd">        Limiting that to only those which are an extension of the given base</span>
<span class="sd">        class.  Among those, return the one whose polymorphic_identity matches</span>
<span class="sd">        the value given.  If none are found, then raise a NameError.</span>

<span class="sd">        Args:</span>
<span class="sd">            identity (EnumSymbol): An instance of EnumSymbol used to identify the child.</span>
<span class="sd">        Returns:</span>
<span class="sd">            BodhiBase: The type-specific child class.</span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If this class is not polymorphic.</span>
<span class="sd">            NameError: If no child class is found for the given identity.</span>
<span class="sd">            TypeError: If identity is not an EnumSymbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">EnumSymbol</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not an instance of EnumSymbol&quot;</span> <span class="o">%</span> <span class="n">identity</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;polymorphic_on&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__mapper_args__&#39;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not a polymorphic model.&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span> <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">cls</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">__mapper_args__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">is</span> <span class="n">identity</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">child</span>

        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Found no child of </span><span class="si">%r</span><span class="s2"> with identity </span><span class="si">%r</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">error</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identity</span><span class="p">))</span></div></div>


<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">BodhiBase</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span>


<span class="c1">##</span>
<span class="c1">#  Enumerated type declarations</span>
<span class="c1">##</span>
<div class="viewcode-block" id="ContentType"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ContentType">[docs]</a><span class="k">class</span> <span class="nc">ContentType</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to differentiate between different kinds of content in various models.</span>

<span class="sd">    This enum is used to mark objects as pertaining to particular kinds of content type, such as</span>
<span class="sd">    RPMs or Modules.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        base (EnumSymbol): This is used to represent base classes that are shared between specific</span>
<span class="sd">            content types.</span>
<span class="sd">        rpm (EnumSymbol): Used to represent RPM related objects.</span>
<span class="sd">        module (EnumSymbol): Used to represent Module related objects.</span>
<span class="sd">        container (EnumSymbol): Used to represent Container related objects.</span>
<span class="sd">        flatpak (EnumSymbol): Used to represent Flatpak related objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;Base&#39;</span>
    <span class="n">rpm</span> <span class="o">=</span> <span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;RPM&#39;</span>
    <span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;Module&#39;</span>
    <span class="n">container</span> <span class="o">=</span> <span class="s1">&#39;container&#39;</span><span class="p">,</span> <span class="s1">&#39;Container&#39;</span>
    <span class="n">flatpak</span> <span class="o">=</span> <span class="s1">&#39;flatpak&#39;</span><span class="p">,</span> <span class="s1">&#39;Flatpak&#39;</span>

<div class="viewcode-block" id="ContentType.infer_content_class"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ContentType.infer_content_class">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">infer_content_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">build</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify and return the child class associated with the appropriate ContentType.</span>

<span class="sd">        For example, given the Package base class and a normal koji build, return</span>
<span class="sd">        the RpmPackage model class. Or, given the Build base class and a container</span>
<span class="sd">        build, return the ContainerBuild model class.</span>

<span class="sd">        Args:</span>
<span class="sd">            base (BodhiBase): A base model class, such as :class:`Build` or :class:`Package`.</span>
<span class="sd">            build (dict): Information about the build from the build system (koji).</span>
<span class="sd">        Returns:</span>
<span class="sd">            BodhiBase: The type-specific child class of base that is appropriate to use with the</span>
<span class="sd">            given koji build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default value.  Overridden below if we find markers in the build info</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rpm</span>

        <span class="n">extra</span> <span class="o">=</span> <span class="n">build</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extra&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;module&#39;</span> <span class="ow">in</span> <span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeinfo&#39;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">module</span>
        <span class="k">elif</span> <span class="s1">&#39;container_koji_task_id&#39;</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;flatpak&#39;</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">flatpak</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">container</span>

        <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">find_polymorphic_child</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UpdateStatus"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.UpdateStatus">[docs]</a><span class="k">class</span> <span class="nc">UpdateStatus</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enum used to describe the current state of an update.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pending (EnumSymbol): The update is not in any repository.</span>
<span class="sd">        testing (EnumSymbol): The update is in the testing repository.</span>
<span class="sd">        stable (EnumSymbol): The update is in the stable repository.</span>
<span class="sd">        unpushed (EnumSymbol): The update had been in a testing repository, but has been removed.</span>
<span class="sd">        obsolete (EnumSymbol): The update has been obsoleted by another update.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pending</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;pending&#39;</span>
    <span class="n">testing</span> <span class="o">=</span> <span class="s1">&#39;testing&#39;</span><span class="p">,</span> <span class="s1">&#39;testing&#39;</span>
    <span class="n">stable</span> <span class="o">=</span> <span class="s1">&#39;stable&#39;</span><span class="p">,</span> <span class="s1">&#39;stable&#39;</span>
    <span class="n">unpushed</span> <span class="o">=</span> <span class="s1">&#39;unpushed&#39;</span><span class="p">,</span> <span class="s1">&#39;unpushed&#39;</span>
    <span class="n">obsolete</span> <span class="o">=</span> <span class="s1">&#39;obsolete&#39;</span><span class="p">,</span> <span class="s1">&#39;obsolete&#39;</span></div>


<div class="viewcode-block" id="TestGatingStatus"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.TestGatingStatus">[docs]</a><span class="k">class</span> <span class="nc">TestGatingStatus</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class lists the different status the ``Update.test_gating_status`` flag can have.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        waiting (EnumSymbol): Bodhi is waiting to hear about the test gating status of the update.</span>
<span class="sd">        ignored (EnumSymbol): Greenwave said that the update does not require any tests.</span>
<span class="sd">        queued (EnumSymbol): Greenwave said that the required tests for this update have been</span>
<span class="sd">            queued.</span>
<span class="sd">        running (EnumSymbol): Greenwave said that the required tests for this update are running.</span>
<span class="sd">        passed (EnumSymbol): Greenwave said that the required tests for this update have passed.</span>
<span class="sd">        failed (EnumSymbol): Greenwave said that the required tests for this update have failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">waiting</span> <span class="o">=</span> <span class="s1">&#39;waiting&#39;</span><span class="p">,</span> <span class="s1">&#39;Waiting&#39;</span>
    <span class="n">ignored</span> <span class="o">=</span> <span class="s1">&#39;ignored&#39;</span><span class="p">,</span> <span class="s1">&#39;Ignored&#39;</span>
    <span class="n">queued</span> <span class="o">=</span> <span class="s1">&#39;queued&#39;</span><span class="p">,</span> <span class="s1">&#39;Queued&#39;</span>
    <span class="n">running</span> <span class="o">=</span> <span class="s1">&#39;running&#39;</span><span class="p">,</span> <span class="s1">&#39;Running&#39;</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="s1">&#39;Passed&#39;</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed&#39;</span>
    <span class="n">greenwave_failed</span> <span class="o">=</span> <span class="s1">&#39;greenwave_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;Greenwave failed to respond&#39;</span></div>


<div class="viewcode-block" id="UpdateType"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.UpdateType">[docs]</a><span class="k">class</span> <span class="nc">UpdateType</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enum used to classify the type of the update.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        bugfix (EnumSymbol): The update fixes bugs only.</span>
<span class="sd">        security (EnumSymbol): The update addresses security issues.</span>
<span class="sd">        newpackage (EnumSymbol): The update introduces new packages to the release.</span>
<span class="sd">        enhancement (EnumSymbol): The update introduces new features.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bugfix</span> <span class="o">=</span> <span class="s1">&#39;bugfix&#39;</span><span class="p">,</span> <span class="s1">&#39;bugfix&#39;</span>
    <span class="n">security</span> <span class="o">=</span> <span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="s1">&#39;security&#39;</span>
    <span class="n">newpackage</span> <span class="o">=</span> <span class="s1">&#39;newpackage&#39;</span><span class="p">,</span> <span class="s1">&#39;newpackage&#39;</span>
    <span class="n">enhancement</span> <span class="o">=</span> <span class="s1">&#39;enhancement&#39;</span><span class="p">,</span> <span class="s1">&#39;enhancement&#39;</span>
    <span class="n">unspecified</span> <span class="o">=</span> <span class="s1">&#39;unspecified&#39;</span><span class="p">,</span> <span class="s1">&#39;unspecified&#39;</span></div>


<div class="viewcode-block" id="UpdateRequest"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.UpdateRequest">[docs]</a><span class="k">class</span> <span class="nc">UpdateRequest</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enum used to specify an update requesting to change states.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        testing (EnumSymbol): The update is requested to change to testing.</span>
<span class="sd">        obsolete (EnumSymbol): The update has been obsoleted by another update.</span>
<span class="sd">        unpush (EnumSymbol): The update no longer needs to be released.</span>
<span class="sd">        revoke (EnumSymbol): The unpushed update will no longer be composed in any repository.</span>
<span class="sd">        stable (EnumSymbol): The update is ready to be pushed to the stable repository.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testing</span> <span class="o">=</span> <span class="s1">&#39;testing&#39;</span><span class="p">,</span> <span class="s1">&#39;testing&#39;</span>
    <span class="n">obsolete</span> <span class="o">=</span> <span class="s1">&#39;obsolete&#39;</span><span class="p">,</span> <span class="s1">&#39;obsolete&#39;</span>
    <span class="n">unpush</span> <span class="o">=</span> <span class="s1">&#39;unpush&#39;</span><span class="p">,</span> <span class="s1">&#39;unpush&#39;</span>
    <span class="n">revoke</span> <span class="o">=</span> <span class="s1">&#39;revoke&#39;</span><span class="p">,</span> <span class="s1">&#39;revoke&#39;</span>
    <span class="n">stable</span> <span class="o">=</span> <span class="s1">&#39;stable&#39;</span><span class="p">,</span> <span class="s1">&#39;stable&#39;</span></div>


<div class="viewcode-block" id="UpdateSeverity"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.UpdateSeverity">[docs]</a><span class="k">class</span> <span class="nc">UpdateSeverity</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enum used to specify the severity of the update.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        unspecified (EnumSymbol): The packager has not specified a severity.</span>
<span class="sd">        urgent (EnumSymbol): The update is urgent.</span>
<span class="sd">        high (EnumSymbol): The update is high severity.</span>
<span class="sd">        medium (EnumSymbol): The update is medium severity.</span>
<span class="sd">        low (EnumSymbol): The update is low severity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unspecified</span> <span class="o">=</span> <span class="s1">&#39;unspecified&#39;</span><span class="p">,</span> <span class="s1">&#39;unspecified&#39;</span>
    <span class="n">urgent</span> <span class="o">=</span> <span class="s1">&#39;urgent&#39;</span><span class="p">,</span> <span class="s1">&#39;urgent&#39;</span>
    <span class="n">high</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span>
    <span class="n">medium</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span>
    <span class="n">low</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span></div>


<div class="viewcode-block" id="UpdateSuggestion"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.UpdateSuggestion">[docs]</a><span class="k">class</span> <span class="nc">UpdateSuggestion</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enum used to tell the user whether they need to reboot or logout after applying an update.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        unspecified (EnumSymbol): No action is needed.</span>
<span class="sd">        reboot (EnumSymbol): The user should reboot after applying the update.</span>
<span class="sd">        logout (EnumSymbol): The user should logout after applying the update.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unspecified</span> <span class="o">=</span> <span class="s1">&#39;unspecified&#39;</span><span class="p">,</span> <span class="s1">&#39;unspecified&#39;</span>
    <span class="n">reboot</span> <span class="o">=</span> <span class="s1">&#39;reboot&#39;</span><span class="p">,</span> <span class="s1">&#39;reboot&#39;</span>
    <span class="n">logout</span> <span class="o">=</span> <span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;logout&#39;</span></div>


<div class="viewcode-block" id="ReleaseState"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ReleaseState">[docs]</a><span class="k">class</span> <span class="nc">ReleaseState</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enum that describes the state of a :class:`Release`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        disabled (EnumSymbol): Indicates that the release is disabled.</span>
<span class="sd">        pending (EnumSymbol): Indicates that the release is pending.</span>
<span class="sd">        frozen (EnumSymbol): Indicates that the release is frozen.</span>
<span class="sd">        current (EnumSymbol): Indicates that the release is current.</span>
<span class="sd">        archived (EnumSymbol): Indicates that the release is archived.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">disabled</span> <span class="o">=</span> <span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span>
    <span class="n">pending</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;pending&#39;</span>
    <span class="n">frozen</span> <span class="o">=</span> <span class="s1">&#39;frozen&#39;</span><span class="p">,</span> <span class="s1">&#39;frozen&#39;</span>
    <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span>
    <span class="n">archived</span> <span class="o">=</span> <span class="s1">&#39;archived&#39;</span><span class="p">,</span> <span class="s1">&#39;archived&#39;</span></div>


<div class="viewcode-block" id="ComposeState"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ComposeState">[docs]</a><span class="k">class</span> <span class="nc">ComposeState</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the various states that a :class:`Compose` can be in.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        requested (EnumSymbol): A compose has been requested, but it has not started yet.</span>
<span class="sd">        pending (EnumSymbol): The request for the compose has been received by the backend worker,</span>
<span class="sd">            but the compose has not started yet.</span>
<span class="sd">        initializing (EnumSymbol): The compose is initializing.</span>
<span class="sd">        updateinfo (EnumSymbol): The updateinfo.xml is being generated.</span>
<span class="sd">        punging (EnumSymbol): A Pungi soldier has been deployed to deal with the situation.</span>
<span class="sd">        syncing_repo (EnumSymbol): The repo is being synced to the master mirror.</span>
<span class="sd">        notifying (EnumSymbol): Pungi has finished successfully, and we are now sending out various</span>
<span class="sd">            forms of notifications, such as e-mail, bus messages, and bugzilla.</span>
<span class="sd">        success (EnumSymbol): The Compose has completed successfully.</span>
<span class="sd">        failed (EnumSymbol): The compose has failed, abandon hope.</span>
<span class="sd">        signing_repo (EnumSymbol): Waiting for the repo to be signed.</span>
<span class="sd">        cleaning (EnumSymbol): Cleaning old Composes after successful completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">requested</span> <span class="o">=</span> <span class="s1">&#39;requested&#39;</span><span class="p">,</span> <span class="s1">&#39;Requested&#39;</span>
    <span class="n">pending</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;Pending&#39;</span>
    <span class="n">initializing</span> <span class="o">=</span> <span class="s1">&#39;initializing&#39;</span><span class="p">,</span> <span class="s1">&#39;Initializing&#39;</span>
    <span class="n">updateinfo</span> <span class="o">=</span> <span class="s1">&#39;updateinfo&#39;</span><span class="p">,</span> <span class="s1">&#39;Generating updateinfo.xml&#39;</span>
    <span class="n">punging</span> <span class="o">=</span> <span class="s1">&#39;punging&#39;</span><span class="p">,</span> <span class="s1">&#39;Waiting for Pungi to finish&#39;</span>
    <span class="n">syncing_repo</span> <span class="o">=</span> <span class="s1">&#39;syncing_repo&#39;</span><span class="p">,</span> <span class="s1">&#39;Wait for the repo to hit the master mirror&#39;</span>
    <span class="n">notifying</span> <span class="o">=</span> <span class="s1">&#39;notifying&#39;</span><span class="p">,</span> <span class="s1">&#39;Sending notifications&#39;</span>
    <span class="n">success</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;Success&#39;</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed&#39;</span>
    <span class="n">signing_repo</span> <span class="o">=</span> <span class="s1">&#39;signing_repo&#39;</span><span class="p">,</span> <span class="s1">&#39;Signing repo&#39;</span>
    <span class="n">cleaning</span> <span class="o">=</span> <span class="s1">&#39;cleaning&#39;</span><span class="p">,</span> <span class="s1">&#39;Cleaning old composes&#39;</span></div>


<div class="viewcode-block" id="PackageManager"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.PackageManager">[docs]</a><span class="k">class</span> <span class="nc">PackageManager</span><span class="p">(</span><span class="n">DeclEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enum used to specify what package manager is used by a specific Release.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        unspecified (EnumSymbol): for releases where the package manager is not specified.</span>
<span class="sd">        dnf (EnumSymbol): DNF package manager.</span>
<span class="sd">        yum (EnumSymbol): YUM package manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unspecified</span> <span class="o">=</span> <span class="s1">&#39;unspecified&#39;</span><span class="p">,</span> <span class="s1">&#39;package manager not specified&#39;</span>
    <span class="n">dnf</span> <span class="o">=</span> <span class="s1">&#39;dnf&#39;</span><span class="p">,</span> <span class="s1">&#39;dnf&#39;</span>
    <span class="n">yum</span> <span class="o">=</span> <span class="s1">&#39;yum&#39;</span><span class="p">,</span> <span class="s1">&#39;yum&#39;</span></div>


<span class="c1">##</span>
<span class="c1">#  Association tables</span>
<span class="c1">##</span>

<span class="n">update_bug_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;update_bug_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;update_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;updates.id&#39;</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;bug_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;bugs.id&#39;</span><span class="p">)))</span>


<span class="n">build_testcase_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;build_testcase_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;build_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;builds.id&#39;</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;testcase_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;testcases.id&#39;</span><span class="p">)))</span>


<div class="viewcode-block" id="Release"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Release">[docs]</a><span class="k">class</span> <span class="nc">Release</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent a distribution release, such as Fedora 27.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of the release, such as &#39;F27&#39;.</span>
<span class="sd">        long_name (str): A human readable name for the release, such as &#39;Fedora 27&#39;.</span>
<span class="sd">        version (str): The version of the release, such as &#39;27&#39;.</span>
<span class="sd">        id_prefix (str): The prefix to use when forming update aliases for this release, such as</span>
<span class="sd">            &#39;FEDORA&#39;.</span>
<span class="sd">        branch (str): The dist-git branch associated with this release, such as &#39;f27&#39;.</span>
<span class="sd">        dist_tag (str): The koji dist_tag associated with this release, such as &#39;f27&#39;.</span>
<span class="sd">        stable_tag (str): The koji tag to be used for stable builds in this release, such as</span>
<span class="sd">            &#39;f27-updates&#39;.</span>
<span class="sd">        testing_tag (str): The koji tag to be used for testing builds in this release, such as</span>
<span class="sd">            &#39;f27-updates-testing&#39;.</span>
<span class="sd">        candidate_tag (str): The koji tag used for builds that are candidates to be updates,</span>
<span class="sd">            such as &#39;f27-updates-candidate&#39;.</span>
<span class="sd">        pending_signing_tag (str): The koji tag that specifies that a build is waiting to be</span>
<span class="sd">            signed, such as &#39;f27-signing-pending&#39;.</span>
<span class="sd">        pending_testing_tag (str): The koji tag that indicates that a build is waiting to be</span>
<span class="sd">            composed into the testing repository, such as &#39;f27-updates-testing-pending&#39;.</span>
<span class="sd">        pending_stable_tag (str): The koji tag that indicates that a build is waiting to be</span>
<span class="sd">            composed into the stable repository, such as &#39;f27-updates-pending&#39;.</span>
<span class="sd">        override_tag (str): The koji tag that is used when a build is added as a buildroot</span>
<span class="sd">            override, such as &#39;f27-override&#39;.</span>
<span class="sd">        mail_template (str): The notification mail template.</span>
<span class="sd">        state (:class:`ReleaseState`): The current state of the release. Defaults to</span>
<span class="sd">            ``ReleaseState.disabled``.</span>
<span class="sd">        builds (sqlalchemy.orm.collections.InstrumentedList): An iterable of :class:`Builds &lt;Build&gt;`</span>
<span class="sd">            associated with this release.</span>
<span class="sd">        composed_by_bodhi (bool): The flag that indicates whether the release is composed by</span>
<span class="sd">            Bodhi or not. Defaults to True.</span>
<span class="sd">        create_automatic_updates (bool): A flag indicating that updates should</span>
<span class="sd">            be created automatically for Koji builds tagged into the</span>
<span class="sd">            ``candidate_tag``. Defaults to False.</span>
<span class="sd">        package_manager (EnumSymbol): The package manager this release uses. This must be one of</span>
<span class="sd">            the values defined in :class:`PackageManager`.</span>
<span class="sd">        testing_repository (str): The name of repository where updates are placed for</span>
<span class="sd">            testing before being pushed to the main repository.</span>
<span class="sd">        eol (str): End-of-life of the release in a datetime.date() format &#39;2020-05-17&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;releases&#39;</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">,</span> <span class="s1">&#39;composes&#39;</span><span class="p">)</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_tag&#39;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">id_prefix</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">branch</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">dist_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">stable_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">testing_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">candidate_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pending_signing_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pending_testing_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pending_stable_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">override_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mail_template</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;fedora_errata_template&#39;</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ReleaseState</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">ReleaseState</span><span class="o">.</span><span class="n">disabled</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">composed_by_bodhi</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">create_automatic_updates</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">_version_int_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\D+(\d+)[CMFN]?$&#39;</span><span class="p">)</span>

    <span class="n">package_manager</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">PackageManager</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">PackageManager</span><span class="o">.</span><span class="n">unspecified</span><span class="p">)</span>
    <span class="n">testing_repository</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">eol</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># One-to-many relationships</span>
    <span class="c1"># builds backref from Build</span>
    <span class="c1"># composes backref from Compos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">critpath_min_karma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the min_karma for critpath updates for this release.</span>

<span class="sd">        If the release doesn&#39;t specify a min_karma, the default critpath.min_karma setting is used</span>
<span class="sd">        instead.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The minimum karma required for critical path updates for this release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setting_status</span><span class="p">:</span>
            <span class="n">min_karma</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_prefix</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_status</span><span class="si">}</span><span class="s1">.critpath.min_karma&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_karma</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_karma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.min_karma&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version_int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an integer representation of the version of this release.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The version of the release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_version_int_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mandatory_days_in_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of days that updates in this release must spend in testing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of days in testing that updates in this release must spend in</span>
<span class="sd">            testing. If the release isn&#39;t configured to have mandatory testing time, 0 is</span>
<span class="sd">            returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setting_status</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_prefix</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_status</span><span class="si">}</span><span class="s1">&#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;.mandatory_days_in_testing&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;.mandatory_days_in_testing&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">days</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No mandatory days in testing defined for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">. Defaulting to 0.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">critpath_mandatory_days_in_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of days that critpath updates in this release must spend in testing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of days in testing that critpath updates in this release must spend in</span>
<span class="sd">            testing. If the release isn&#39;t configured to have critpath mandatory testing time, 0 is</span>
<span class="sd">            returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setting_status</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_prefix</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_status</span><span class="si">}</span><span class="s1">&#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;.critpath.stable_after_days_without_negative_karma&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">days</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.stable_after_days_without_negative_karma&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the collection name of this release (eg: Fedora EPEL).</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The collection name of this release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="Release.all_releases"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Release.all_releases">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all_releases</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a mapping of release states to a list of dictionaries describing the releases.</span>

<span class="sd">        Returns:</span>
<span class="sd">            defaultdict: Mapping strings of :class:`ReleaseState` names to lists of dictionaries</span>
<span class="sd">            that describe the releases in those states.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_all_releases</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_all_releases</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">releases</span><span class="p">[</span><span class="n">release</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">release</span><span class="o">.</span><span class="n">__json__</span><span class="p">())</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_all_releases</span> <span class="o">=</span> <span class="n">releases</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_all_releases</span></div>
    <span class="n">_all_releases</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Release.clear_all_releases_cache"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Release.clear_all_releases_cache">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clear_all_releases_cache</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear up Release cache.&quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_all_releases</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Release.get_tags"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Release.get_tags">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a 2-tuple mapping tags to releases.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 2-tuple. The first element maps the keys &#39;candidate&#39;, &#39;testing&#39;, &#39;stable&#39;,</span>
<span class="sd">            &#39;override&#39;, &#39;pending_testing&#39;, and &#39;pending_stable&#39; each to a list of tags for various</span>
<span class="sd">            releases that correspond to those tag semantics. The second element maps each koji tag</span>
<span class="sd">            to the release&#39;s name that uses it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_tag_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_tag_cache</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;candidate&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;testing&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stable&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;override&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;pending_testing&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;pending_stable&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># tag -&gt; release lookup</span>
        <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">release</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_tag&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_tag_cache</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_tag_cache</span></div>
    <span class="n">_tag_cache</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Release.from_tags"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Release.from_tags">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_tags</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find a release associated with one of the given koji tags.</span>

<span class="sd">        Args:</span>
<span class="sd">            tags (list): A list of koji tags for which an associated release is desired.</span>
<span class="sd">            session (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Release or None: The first release found that matches the first tag. If no release is</span>
<span class="sd">                found, ``None`` is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag_types</span><span class="p">,</span> <span class="n">tag_rels</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_tags</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tag_rels</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">release</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag_rels</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">release</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">release</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">setting_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the prefix for settings that pertain to this Release.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Release&#39;s setting prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">setting_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the status of the Release from settings.</span>

<span class="sd">        Return the Release&#39;s status setting from the config. For example, if the release is f30,</span>
<span class="sd">        this will return the value of f30.status from the config file.</span>

<span class="sd">        Note: This is not the same as Release.state.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The status of the release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_prefix</span><span class="si">}</span><span class="s1">.status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="Release.get_pending_testing_side_tag"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Release.get_pending_testing_side_tag">[docs]</a>    <span class="k">def</span> <span class="nf">get_pending_testing_side_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the testing-pending side tag for this ``Release``.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_tag: Name of side tag from which ``Update`` was created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Testing-pending side tag used in koji.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">side_tag_postfix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_prefix</span><span class="si">}</span><span class="s1">.koji-testing-side-tag&#39;</span><span class="p">,</span> <span class="s2">&quot;-testing-pending&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">from_tag</span> <span class="o">+</span> <span class="n">side_tag_postfix</span></div>

<div class="viewcode-block" id="Release.get_pending_signing_side_tag"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Release.get_pending_signing_side_tag">[docs]</a>    <span class="k">def</span> <span class="nf">get_pending_signing_side_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the signing-pending side tag for this ``Release``.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_tag: Name of side tag from which ``Update`` was created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Signing-pending side tag used in koji.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">side_tag_postfix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setting_prefix</span><span class="si">}</span><span class="s1">.koji-signing-pending-side-tag&#39;</span><span class="p">,</span> <span class="s2">&quot;-signing-pending&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">from_tag</span> <span class="o">+</span> <span class="n">side_tag_postfix</span></div></div>


<div class="viewcode-block" id="TestCase"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.TestCase">[docs]</a><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents test cases from the wiki.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of the test case.</span>
<span class="sd">        package_name (str): The name of the package associated with this test case.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;testcases&#39;</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;builds&#39;</span><span class="p">,</span> <span class="s1">&#39;feedback&#39;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="c1"># One-to-many relationships</span>
    <span class="c1"># feedback backref from TestCaseKarma</span>

    <span class="c1"># Many-to-many relationships</span>
    <span class="c1"># builds backref</span>


<div class="viewcode-block" id="Package"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Package">[docs]</a><span class="k">class</span> <span class="nc">Package</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model represents a package.</span>

<span class="sd">    This model uses single-table inheritance to allow for different package types.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): A text string that uniquely identifies the package.</span>
<span class="sd">        requirements (str): A text string that lists space-separated taskotron test</span>
<span class="sd">            results that must pass for this package</span>
<span class="sd">        type (int): The polymorphic identity column. This is used to identify what Python</span>
<span class="sd">            class to create when loading rows from the database.</span>
<span class="sd">        builds (sqlalchemy.orm.collections.InstrumentedList): A list of :class:`Build` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;packages&#39;</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">,)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">requirements</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ContentType</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># One-to-many relationships</span>
    <span class="n">builds</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;package&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;packages_name_and_type_key&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">external_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the package name as it&#39;s known to external services.</span>

<span class="sd">        For most Packages, this is self.name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name of this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="Package.get_pkg_committers_from_pagure"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Package.get_pkg_committers_from_pagure">[docs]</a>    <span class="k">def</span> <span class="nf">get_pkg_committers_from_pagure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull users and groups who can commit on a package in Pagure.</span>

<span class="sd">        Returns a tuple with two lists:</span>
<span class="sd">        * The first list contains usernames that have commit access.</span>
<span class="sd">        * The second list contains FAS group names that have commit access.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Pagure did not give us a 200 code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pagure_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pagure_url&#39;</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pagure_namespaces&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">package_pagure_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/api/0/</span><span class="si">{1}</span><span class="s1">/</span><span class="si">{2}</span><span class="s1">?expand_group=1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pagure_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_name</span><span class="p">)</span>
        <span class="n">package_json</span> <span class="o">=</span> <span class="n">pagure_api_get</span><span class="p">(</span><span class="n">package_pagure_url</span><span class="p">)</span>

        <span class="n">committers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">access_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;commit&#39;</span><span class="p">]:</span>
            <span class="n">committers</span> <span class="o">=</span> <span class="n">committers</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">package_json</span><span class="p">[</span><span class="s1">&#39;access_users&#39;</span><span class="p">][</span><span class="n">access_type</span><span class="p">])</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">access_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;commit&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">package_json</span><span class="p">[</span><span class="s1">&#39;access_groups&#39;</span><span class="p">][</span><span class="n">access_type</span><span class="p">]:</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
                <span class="c1"># Add to the list of committers the users in the groups</span>
                <span class="c1"># having admin or commit access</span>
                <span class="n">committers</span> <span class="o">=</span> <span class="n">committers</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="n">package_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;group_details&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="c1"># The first list contains usernames with commit access. The second list</span>
        <span class="c1"># contains FAS group names with commit access.</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">committers</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span></div>

<div class="viewcode-block" id="Package.hascommitaccess"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Package.hascommitaccess">[docs]</a>    <span class="k">def</span> <span class="nf">hascommitaccess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">branchname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check on Pagure if a user has commit access on the package/branch.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Pagure did not give us a 200 code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pagure_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pagure_url&#39;</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pagure_namespaces&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># Here we override the queried branchname because:</span>
        <span class="c1"># - flatpaks only have one main branch</span>
        <span class="c1"># - modules streams have no direct mapping to branch names</span>
        <span class="c1"># The effect is that we cannot check collaborators rights for specific</span>
        <span class="c1"># streams on modules, so we fall back to old Bodhi behavior</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">flatpak</span><span class="p">:</span>
            <span class="n">branchname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pagure_flatpak_main_branch&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
            <span class="n">branchname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pagure_module_main_branch&#39;</span><span class="p">)</span>

        <span class="n">pagure_query_url</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pagure_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/api/0/</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">external_name</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;/hascommit?user=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">&amp;branch=</span><span class="si">{</span><span class="n">branchname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">pagure_response</span> <span class="o">=</span> <span class="n">pagure_api_get</span><span class="p">(</span><span class="n">pagure_query_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pagure_response</span><span class="p">[</span><span class="s1">&#39;hascommit&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Package.validate_builds"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Package.validate_builds">[docs]</a>    <span class="nd">@validates</span><span class="p">(</span><span class="s1">&#39;builds&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_builds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">build</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate builds being appended to ensure they are all the same type as the Package.</span>

<span class="sd">        This method checks to make sure that all the builds on self.builds have their type attribute</span>
<span class="sd">        equal to self.type. The goal is to make sure that Builds of a specific type are only ever</span>
<span class="sd">        associated with Packages of the same type and vice-versa. For example, RpmBuilds should only</span>
<span class="sd">        ever associate with RpmPackages and never with ModulePackages.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The field&#39;s key, which is un-used in this validator.</span>
<span class="sd">            build (Build): The build object which was appended to the list</span>
<span class="sd">                of builds.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the build being appended is not the same type as the package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">build</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;A </span><span class="si">{}</span><span class="s2"> Build cannot be associated with a </span><span class="si">{}</span><span class="s2"> Package. A Package&#39;s builds must be &quot;</span>
                 <span class="s2">&quot;the same type as the package.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="n">build</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">build</span></div>

<div class="viewcode-block" id="Package.__str__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Package.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation of the package.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representing this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pending&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;testing&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stable&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">build</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">build</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
                    <span class="n">states</span><span class="p">[</span><span class="n">build</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">build</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">]:</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> Updates (</span><span class="si">%d</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
                                               <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">]:</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="s2">&quot;    o </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">update</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">states</span>
        <span class="k">return</span> <span class="n">x</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="n">build</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the package name for a particular build.</span>

<span class="sd">        For most builds, this will return the RPM name, unless overridden in a specific</span>
<span class="sd">        subclass.</span>

<span class="sd">        Args:</span>
<span class="sd">            build (dict): Information about the build from the build system (koji).</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The Package object identifier for this build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">build</span><span class="p">[</span><span class="s1">&#39;nvr&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">name</span>

<div class="viewcode-block" id="Package.check_existence"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Package.check_existence">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_existence</span><span class="p">(</span><span class="n">build</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the Package instance associated with the build is already in database.</span>

<span class="sd">        Args:</span>
<span class="sd">            build (dict): Information about the build from the build system (koji).</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the type-specific instance of Package is alreadi in database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">infer_content_class</span><span class="p">(</span><span class="n">Package</span><span class="p">,</span> <span class="n">build</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>
        <span class="n">package</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">package</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Package.get_or_create"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Package.get_or_create">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">build</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify and return the Package instance associated with the build.</span>

<span class="sd">        For example, given a normal koji build, return a RpmPackage instance.</span>
<span class="sd">        Or, given a container, return a ContainerBuild instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">            build (dict): Information about the build from the build system (koji).</span>
<span class="sd">        Returns:</span>
<span class="sd">            Package: A type-specific instance of Package for the specific build requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">infer_content_class</span><span class="p">(</span><span class="n">Package</span><span class="p">,</span> <span class="n">build</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>
        <span class="n">package</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">package</span><span class="p">:</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">base</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">package</span></div></div>


<div class="viewcode-block" id="ContainerPackage"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ContainerPackage">[docs]</a><span class="k">class</span> <span class="nc">ContainerPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a Container package.&quot;&quot;&quot;</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="FlatpakPackage"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.FlatpakPackage">[docs]</a><span class="k">class</span> <span class="nc">FlatpakPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a Flatpak package.&quot;&quot;&quot;</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">flatpak</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="ModulePackage"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ModulePackage">[docs]</a><span class="k">class</span> <span class="nc">ModulePackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a Module package.&quot;&quot;&quot;</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">external_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the package name as it&#39;s known to external services.</span>

<span class="sd">        For modules, this splits the :stream portion back off.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name of this module package without :stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="n">build</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the name:stream for a particular module build.</span>

<span class="sd">        Args:</span>
<span class="sd">            build (dict): Information about the build from the build system (koji).</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The name:stream of this module build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">build</span><span class="p">[</span><span class="s1">&#39;nvr&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span></div>


<div class="viewcode-block" id="RpmPackage"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.RpmPackage">[docs]</a><span class="k">class</span> <span class="nc">RpmPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a RPM package.&quot;&quot;&quot;</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">rpm</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="Build"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build">[docs]</a><span class="k">class</span> <span class="nc">Build</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model represents a specific build of a package.</span>

<span class="sd">    This model uses single-table inheritance to allow for different build types.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nvr (str): The nvr field is really a mapping to the Koji build_target.name field, and is</span>
<span class="sd">            used to reference builds in Koji. It is named nvr in reference to the dash-separated</span>
<span class="sd">            name-version-release Koji name for RPMs, but it is used by other types as well. At the</span>
<span class="sd">            time of this writing, it was not practical to rename nvr since it is used in the REST</span>
<span class="sd">            API to reference builds. Thus, it should be thought of as a Koji build identifier rather</span>
<span class="sd">            than strictly as an RPM&#39;s name, version, and release.</span>
<span class="sd">        package_id (int): A foreign key to the Package that this Build is part of.</span>
<span class="sd">        release_id (int): A foreign key to the Release that this Build is part of.</span>
<span class="sd">        signed (bool): If True, this package has been signed by robosignatory. If False, it has not</span>
<span class="sd">            been signed yet.</span>
<span class="sd">        update_id (int): A foreign key to the Update that this Build is part of.</span>
<span class="sd">        release (sqlalchemy.orm.relationship): A relationship to the Release that this build is part</span>
<span class="sd">            of.</span>
<span class="sd">        type (ContentType): The polymorphic identify of the row. This is used by sqlalchemy to</span>
<span class="sd">            identify which subclass of Build to use.</span>
<span class="sd">        testcases (sqlalchemy.orm.collections.InstrumentedList): A list of :class:`TestCase`</span>
<span class="sd">            objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;builds&#39;</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;package&#39;</span><span class="p">,</span> <span class="s1">&#39;package_id&#39;</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="s1">&#39;testcases&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;update_id&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;override&#39;</span><span class="p">)</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nvr&#39;</span><span class="p">,)</span>

    <span class="n">nvr</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">signed</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Many-to-one relationships</span>
    <span class="n">package_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;packages.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># package backref from Package</span>
    <span class="n">release_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;releases.id&#39;</span><span class="p">))</span>
    <span class="n">release</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Release&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;builds&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">update_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;updates.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># update backref from Update</span>

    <span class="c1"># Many-to-many relationships</span>
    <span class="n">testcases</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;TestCase&#39;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">build_testcase_table</span><span class="p">,</span>
                             <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;builds&#39;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;TestCase.name&#39;</span><span class="p">)</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ContentType</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_kojiinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return Koji build info about this build, from a cache if possible.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The response from Koji&#39;s getBuild() for this Build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_kojiinfo&#39;</span><span class="p">):</span>
            <span class="n">koji_session</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kojiinfo</span> <span class="o">=</span> <span class="n">koji_session</span><span class="o">.</span><span class="n">getBuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kojiinfo</span>

    <span class="k">def</span> <span class="nf">_get_n_v_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the N, V and R components for a traditionally dash-separated build.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 3-tuple of name, version, release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvr_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the RPM name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name of the Build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_v_r</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvr_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the RPM version.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The version of the Build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_v_r</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvr_release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the RPM release.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The release of the Build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_v_r</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="Build.get_n_v_r"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.get_n_v_r">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_v_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the (name, version, release) of this build.</span>

<span class="sd">        Note: This does not directly return the Build&#39;s nvr attribute, which is a str.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 3-tuple representing the name, version and release from the build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr_version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr_release</span><span class="p">)</span></div>

<div class="viewcode-block" id="Build.get_tags"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.get_tags">[docs]</a>    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">koji</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of koji tags for this build.</span>

<span class="sd">        Args:</span>
<span class="sd">            koji (bodhi.server.buildsys.Buildsysem or koji.ClientSession): A koji client. Defaults</span>
<span class="sd">                to calling bodhi.server.buildsys.get_session().</span>
<span class="sd">        Return:</span>
<span class="sd">            list: A list of strings of the Koji tags on this Build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">koji</span><span class="p">:</span>
            <span class="n">koji</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">koji</span><span class="o">.</span><span class="n">listTags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Build.get_owner_name"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.get_owner_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_owner_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the koji username of the user who built the build.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The username of the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()[</span><span class="s1">&#39;owner_name&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Build.get_build_id"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.get_build_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_build_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the koji build id of the build.</span>

<span class="sd">        Returns:</span>
<span class="sd">            id: The task/build if of the build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Build.get_task_id"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.get_task_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the koji task id of the build.</span>

<span class="sd">        Returns:</span>
<span class="sd">            id: The task if of the build or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Build.get_changelog"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.get_changelog">[docs]</a>    <span class="k">def</span> <span class="nf">get_changelog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lastupdate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Will be overridden from child classes, when appropriate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="Build.get_creation_time"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.get_creation_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_creation_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the creation time of the build.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()[</span><span class="s1">&#39;creation_time&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Build.unpush"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.unpush">[docs]</a>    <span class="k">def</span> <span class="nf">unpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">koji</span><span class="p">,</span> <span class="n">from_side_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move this build back to the candidate tag and remove any pending tags.</span>

<span class="sd">        Args:</span>
<span class="sd">            koji (bodhi.server.buildsys.Buildsysem or koji.ClientSession): A koji client.</span>
<span class="sd">            from_side_tag (bool): if the build was originally built in a side-tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unpushing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
        <span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">release</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tags</span><span class="p">(</span><span class="n">koji</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing </span><span class="si">%s</span><span class="s1"> tag from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">))</span>
                <span class="n">koji</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">release</span><span class="o">.</span><span class="n">pending_testing_tag</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing </span><span class="si">%s</span><span class="s1"> tag from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">))</span>
                <span class="n">koji</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">release</span><span class="o">.</span><span class="n">pending_stable_tag</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing </span><span class="si">%s</span><span class="s1"> tag from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">))</span>
                <span class="n">koji</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">release</span><span class="o">.</span><span class="n">testing_tag</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">from_side_tag</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Moving </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">koji</span><span class="o">.</span><span class="n">moveBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removing </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1"> tag from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">koji</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">from_side_tag</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removing </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1"> tag from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">koji</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Build.is_latest"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.is_latest">[docs]</a>    <span class="k">def</span> <span class="nf">is_latest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is the latest build available in the stable tag.&quot;&quot;&quot;</span>
        <span class="n">koji_session</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="c1"># Get the latest builds in koji in a tag for a package</span>
        <span class="n">koji_builds</span> <span class="o">=</span> <span class="n">koji_session</span><span class="o">.</span><span class="n">getLatestBuilds</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">stable_tag</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">koji_build</span> <span class="ow">in</span> <span class="n">koji_builds</span><span class="p">:</span>
            <span class="n">build_creation_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">koji_build</span><span class="p">[</span><span class="s1">&#39;creation_time&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_creation_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">build_creation_time</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Build.update_test_cases"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Build.update_test_cases">[docs]</a>    <span class="k">def</span> <span class="nf">update_test_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the list of test cases for this build from the wiki.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ExternalCallException: When retrieving testcases from Wiki failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_wiki_test_cases&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Querying the wiki for test cases of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wiki</span> <span class="o">=</span> <span class="n">MediaWiki</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wiki_url&#39;</span><span class="p">),</span>
                             <span class="n">user_agent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wiki_user_agent&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExternalCallException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to connect to Fedora Wiki: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">cat_page</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Package </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">external_name</span><span class="si">}</span><span class="s1"> test cases&#39;</span>

        <span class="k">def</span> <span class="nf">list_categorymembers</span><span class="p">(</span><span class="n">wiki</span><span class="p">,</span> <span class="n">cat_page</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">wiki</span><span class="o">.</span><span class="n">categorymembers</span><span class="p">(</span><span class="n">cat_page</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">subcategories</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExternalCallException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed retrieving testcases from Wiki: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">entry</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

            <span class="c1"># Determine whether we need to recurse</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subcat</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">members</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">list_categorymembers</span><span class="p">(</span><span class="n">wiki</span><span class="p">,</span> <span class="n">subcat</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)))</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found the following testcases: </span><span class="si">{</span><span class="n">members</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">members</span>

        <span class="n">fetched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_categorymembers</span><span class="p">(</span><span class="n">wiki</span><span class="p">,</span> <span class="n">cat_page</span><span class="p">))</span>

        <span class="c1"># Delete removed testcases</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testcases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fetched</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testcases</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed testcase &quot;</span><span class="si">{</span><span class="n">case</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Add new testcases</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">fetched</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">TestCase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">TestCase</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found new testcase &quot;</span><span class="si">{</span><span class="n">case</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; and added to database&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testcases</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Added testcase &quot;</span><span class="si">{</span><span class="n">case</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Finished querying for test cases in </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ContainerBuild"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ContainerBuild">[docs]</a><span class="k">class</span> <span class="nc">ContainerBuild</span><span class="p">(</span><span class="n">Build</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a Container build.</span>

<span class="sd">    Note that this model uses single-table inheritance with its Build superclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="FlatpakBuild"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.FlatpakBuild">[docs]</a><span class="k">class</span> <span class="nc">FlatpakBuild</span><span class="p">(</span><span class="n">Build</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a Flatpak build.</span>

<span class="sd">    Note that this model uses single-table inheritance with its Build superclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">flatpak</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="ModuleBuild"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.ModuleBuild">[docs]</a><span class="k">class</span> <span class="nc">ModuleBuild</span><span class="p">(</span><span class="n">Build</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a Module build.</span>

<span class="sd">    Note that this model uses single-table inheritance with its Build superclass.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nvr (str): A unique Koji identifier for the module build.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvr_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the ModuleBuild&#39;s name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name of the module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvr_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the the ModuleBuild&#39;s stream.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The stream of the ModuleBuild.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvr_release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the ModuleBuild&#39;s version and context.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The version of the ModuleBuild.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()[</span><span class="s1">&#39;release&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="RpmBuild"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.RpmBuild">[docs]</a><span class="k">class</span> <span class="nc">RpmBuild</span><span class="p">(</span><span class="n">Build</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an RPM build.</span>

<span class="sd">    Note that this model uses single-table inheritance with its Build superclass.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nvr (str): A dash (-) separated string of an RPM&#39;s name, version, and release (e.g.</span>
<span class="sd">            &#39;bodhi-2.5.0-1.fc26&#39;)</span>
<span class="sd">        epoch (int): The RPM&#39;s epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">rpm</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the RpmBuild&#39;s epoch, version, release, all strings in a 3-tuple.</span>

<span class="sd">        Return:</span>
<span class="sd">            tuple: (epoch, version, release)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_kojiinfo</span><span class="p">()[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr_version</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr_release</span><span class="p">))</span>

<div class="viewcode-block" id="RpmBuild.get_latest"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.RpmBuild.get_latest">[docs]</a>    <span class="k">def</span> <span class="nf">get_latest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the nvr string of the most recent evr that is less than this RpmBuild&#39;s nvr.</span>

<span class="sd">        If there is no other Build, this returns ``None``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str or None: An nvr string, formatted like RpmBuild.nvr. If there is no other</span>
<span class="sd">                Build, returns ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">koji_session</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>

        <span class="c1"># Grab a list of builds tagged with ``Release.stable_tag`` release</span>
        <span class="c1"># tags, and find the most recent update for this package, other than</span>
        <span class="c1"># this one.  If nothing is tagged for -updates, then grab the first</span>
        <span class="c1"># thing in ``Release.dist_tag``.  We aren&#39;t checking</span>
        <span class="c1"># ``Release.candidate_tag`` first, because there could potentially be</span>
        <span class="c1"># packages that never make their way over stable, so we don&#39;t want to</span>
        <span class="c1"># generate ChangeLogs against those.</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">evr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evr</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">stable_tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">dist_tag</span><span class="p">]:</span>
            <span class="n">builds</span> <span class="o">=</span> <span class="n">koji_session</span><span class="o">.</span><span class="n">listTagged</span><span class="p">(</span>
                <span class="n">tag</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Find the first build that is older than us</span>
            <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">builds</span><span class="p">:</span>
                <span class="n">old_evr</span> <span class="o">=</span> <span class="n">build_evr</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rpm</span><span class="o">.</span><span class="n">labelCompare</span><span class="p">(</span><span class="n">evr</span><span class="p">,</span> <span class="n">old_evr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">latest</span> <span class="o">=</span> <span class="n">build</span><span class="p">[</span><span class="s1">&#39;nvr&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">latest</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">latest</span></div>

<div class="viewcode-block" id="RpmBuild.get_changelog"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.RpmBuild.get_changelog">[docs]</a>    <span class="k">def</span> <span class="nf">get_changelog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lastupdate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the RPM changelog of this package since it&#39;s last update, or since timelimit.</span>

<span class="sd">        Args:</span>
<span class="sd">            timelimit (int): Timestamp, specified as the number of seconds since 1970-01-01 00:00:00</span>
<span class="sd">                UTC.</span>
<span class="sd">            lastupdate (bool): Only returns changelog since last update.</span>
<span class="sd">        Return:</span>
<span class="sd">            str: The RpmBuild&#39;s changelog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rpm_header</span> <span class="o">=</span> <span class="n">get_rpm_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
        <span class="n">descrip</span> <span class="o">=</span> <span class="n">rpm_header</span><span class="p">[</span><span class="s1">&#39;changelogtext&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">descrip</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">who</span> <span class="o">=</span> <span class="n">rpm_header</span><span class="p">[</span><span class="s1">&#39;changelogname&#39;</span><span class="p">]</span>
        <span class="n">when</span> <span class="o">=</span> <span class="n">rpm_header</span><span class="p">[</span><span class="s1">&#39;changelogtime&#39;</span><span class="p">]</span>

        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">descrip</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">when</span> <span class="o">=</span> <span class="p">[</span><span class="n">when</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">lastupdate</span><span class="p">:</span>
            <span class="n">lastpkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latest</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lastpkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">oldh</span> <span class="o">=</span> <span class="n">get_rpm_header</span><span class="p">(</span><span class="n">lastpkg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oldh</span><span class="p">[</span><span class="s1">&#39;changelogtext&#39;</span><span class="p">]:</span>
                    <span class="n">timelimit</span> <span class="o">=</span> <span class="n">oldh</span><span class="p">[</span><span class="s1">&#39;changelogtime&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timelimit</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">timelimit</span> <span class="o">=</span> <span class="n">timelimit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">when</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">timelimit</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">str</span> <span class="o">+=</span> <span class="s1">&#39;* </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%e</span><span class="s2"> %Y&quot;</span><span class="p">,</span>
                                          <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">when</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">who</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">descrip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Unable to add changelog entry for header </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">rpm_header</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">str</span></div></div>


<span class="k">if</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">sqlalchemy_version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">parse_version</span><span class="p">(</span><span class="s2">&quot;1.4.0&quot;</span><span class="p">):</span>
    <span class="n">overlaps_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;overlaps&quot;</span><span class="p">:</span> <span class="s2">&quot;release&quot;</span><span class="p">}</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">overlaps_kw</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="Update"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update">[docs]</a><span class="k">class</span> <span class="nc">Update</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model represents an update.</span>

<span class="sd">    The update contains not just one package, but a collection of packages. Each</span>
<span class="sd">    package can be referenced only once in one Update. Packages are referenced</span>
<span class="sd">    through their Build objects using field ``builds`` below.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        autokarma (bool): A boolean that indicates whether or not the update will</span>
<span class="sd">            be automatically pushed when the stable_karma threshold is reached.</span>
<span class="sd">        autotime (bool): A boolean that indicates whether or not the update will</span>
<span class="sd">            be automatically pushed when the time threshold is reached.</span>
<span class="sd">        stable_karma (int): A positive integer that indicates the amount of &quot;good&quot;</span>
<span class="sd">            karma the update must receive before being automatically marked as stable.</span>
<span class="sd">        stable_days (int): A positive integer that indicates the number of days an update</span>
<span class="sd">            needs to spend in testing before being automatically marked as stable.</span>
<span class="sd">        unstable_karma (int): A positive integer that indicates the amount of &quot;bad&quot;</span>
<span class="sd">            karma the update must receive before being automatically marked as unstable.</span>
<span class="sd">        requirements (str): A list of taskotron tests that must pass for this</span>
<span class="sd">            update to be considered stable.</span>
<span class="sd">        require_bugs (bool): Indicates whether or not positive feedback needs to be</span>
<span class="sd">            provided for the associated bugs before the update can be considered</span>
<span class="sd">            stable.</span>
<span class="sd">        require_testcases (bool): Indicates whether or not the update requires that</span>
<span class="sd">            positive feedback be given on all associated wiki test cases before the</span>
<span class="sd">            update can pass to stable. If the update has no associated wiki test cases,</span>
<span class="sd">            this option has no effect.</span>
<span class="sd">        display_name (str): Allows the user to customize the name of the update.</span>
<span class="sd">        notes (str): Notes about the update. This is a human-readable field that</span>
<span class="sd">            describes what the update is for (e.g. the bugs it fixes).</span>
<span class="sd">        type (EnumSymbol): The type of the update (e.g. enhancement, bugfix, etc). It</span>
<span class="sd">            must be one of the values defined in :class:`UpdateType`.</span>
<span class="sd">        status (EnumSymbol): The current status of the update. Possible values include</span>
<span class="sd">            &#39;pending&#39; to indicate it is not yet in a repository, &#39;testing&#39; to indicate it</span>
<span class="sd">            is in the testing repository, etc. It must be one of the values defined in</span>
<span class="sd">            :class:`UpdateStatus`.</span>
<span class="sd">        request (EnumSymbol): The requested status of the update. This must be one of the</span>
<span class="sd">            values defined in :class:`UpdateRequest` or ``None``.</span>
<span class="sd">        severity (EnumSymbol): The update&#39;s severity. This must be one of the values defined</span>
<span class="sd">            in :class:`UpdateSeverity`.</span>
<span class="sd">        suggest (EnumSymbol): Suggested action a user should take after applying the update.</span>
<span class="sd">            This must be one of the values defined in :class:`UpdateSuggestion`.</span>
<span class="sd">        locked (bool): Indicates whether or not the update is locked and un-editable.</span>
<span class="sd">            This is usually set by the composer because the update is going through a state</span>
<span class="sd">            transition.</span>
<span class="sd">        pushed (bool): Indicates whether or not the update has been pushed to its requested</span>
<span class="sd">            repository.</span>
<span class="sd">        critpath (bool): Indicates whether or not the update is for a &quot;critical path&quot;</span>
<span class="sd">            :class:`Package`. Critical path packages are packages that are required for</span>
<span class="sd">            basic functionality. For example, the kernel :class:`RpmPackage` is a critical</span>
<span class="sd">            path package.</span>
<span class="sd">        critpath_groups (str): Space-separated list of critical path groups the package(s)</span>
<span class="sd">            in this update are members of. More detailed version of critpath. Empty string</span>
<span class="sd">            means &quot;no groups&quot; (same as critpath=False); None/null means &quot;feature not supported&quot;</span>
<span class="sd">            (i.e. the configured critpath.type doesn&#39;t give grouped critpath info).</span>
<span class="sd">        close_bugs (bool): Indicates whether the Bugzilla bugs that this update is related</span>
<span class="sd">            to should be closed automatically when the update is pushed to stable.</span>
<span class="sd">        date_submitted (DateTime): The date that the update was created.</span>
<span class="sd">        date_modified (DateTime): The date the update was last modified or ``None``.</span>
<span class="sd">        date_approved (DateTime): The date the update was approved or ``None``.</span>
<span class="sd">        date_testing (DateTime): The date the update was placed into the testing repository</span>
<span class="sd">            or ``None``.</span>
<span class="sd">        date_stable (DateTime): The date the update was placed into the stable repository or</span>
<span class="sd">            ``None``.</span>
<span class="sd">        alias (str): The update alias (e.g. FEDORA-EPEL-2009-12345).</span>
<span class="sd">        release_id (int): A foreign key to the releases ``id``.</span>
<span class="sd">        release (Release): The ``Release`` object this update relates to via the ``release_id``.</span>
<span class="sd">        comments (sqlalchemy.orm.collections.InstrumentedList): A list of the :class:`Comment`</span>
<span class="sd">            objects for this update.</span>
<span class="sd">        builds (sqlalchemy.orm.collections.InstrumentedList): A list of :class:`Build` objects</span>
<span class="sd">            contained in this update.</span>
<span class="sd">        bugs (sqlalchemy.orm.collections.InstrumentedList): A list of :class:`Bug` objects</span>
<span class="sd">            associated with this update.</span>
<span class="sd">        user_id (int): A foreign key to the :class:`User` that created this update.</span>
<span class="sd">        test_gating_status (EnumSymbol): The test gating status of the update. This must be one</span>
<span class="sd">            of the values defined in :class:`TestGatingStatus` or ``None``. None indicates that</span>
<span class="sd">            Greenwave integration was not enabled when the update was created.</span>
<span class="sd">        compose (Compose): The :class:`Compose` that this update is currently being composed in. The</span>
<span class="sd">            update is locked if this is defined.</span>
<span class="sd">        from_tag (str): The koji tag from which the list of builds was</span>
<span class="sd">            originally populated (if any).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;updates&#39;</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;release_id&#39;</span><span class="p">)</span>
    <span class="n">__include_extras__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;date_pushed&#39;</span><span class="p">,</span> <span class="s1">&#39;meets_testing_requirements&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;version_hash&#39;</span><span class="p">)</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,)</span>

    <span class="n">autokarma</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">autotime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">stable_karma</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">stable_days</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">unstable_karma</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">requirements</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">)</span>
    <span class="n">require_bugs</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">require_testcases</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">display_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Mandatory notes</span>

    <span class="c1"># Enumerated types</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UpdateType</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UpdateStatus</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">,</span>
                    <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UpdateRequest</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UpdateSeverity</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">UpdateSeverity</span><span class="o">.</span><span class="n">unspecified</span><span class="p">)</span>
    <span class="n">suggest</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UpdateSuggestion</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">UpdateSuggestion</span><span class="o">.</span><span class="n">unspecified</span><span class="p">)</span>

    <span class="c1"># Flags</span>
    <span class="n">locked</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pushed</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">critpath</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">critpath_groups</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Bug settings</span>
    <span class="n">close_bugs</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Timestamps</span>
    <span class="n">date_submitted</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">date_modified</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">date_approved</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">date_testing</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">date_stable</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">)</span>

    <span class="c1"># eg: FEDORA-EPEL-2009-12345</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Many-to-one relationships</span>
    <span class="n">release_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;releases.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">release</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Release&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">))</span>
    <span class="c1"># user backref from User</span>

    <span class="c1"># If the update is locked and a Compose exists for the same release and request, this will be</span>
    <span class="c1"># set to that Compose.</span>
    <span class="n">compose</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Compose&#39;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;and_(Update.release_id==Compose.release_id, Update.request==Compose.request, &quot;</span>
                     <span class="s2">&quot;Update.locked==True)&quot;</span><span class="p">),</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="p">(</span><span class="n">release_id</span><span class="p">,</span> <span class="n">request</span><span class="p">),</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;updates&#39;</span><span class="p">,</span> <span class="n">passive_deletes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;Update.date_submitted&#39;</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">overlaps_kw</span><span class="p">),</span>
        <span class="o">**</span><span class="n">overlaps_kw</span><span class="p">)</span>

    <span class="c1"># One-to-many relationships</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Comment&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all,delete,delete-orphan&quot;</span><span class="p">,</span>
                            <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;Comment.timestamp&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">)</span>
    <span class="n">builds</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;Build.nvr&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">)</span>

    <span class="c1"># Many-to-many relationships</span>
    <span class="n">bugs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Bug&#39;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">update_bug_table</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;updates&#39;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;Bug.bug_id&#39;</span><span class="p">)</span>

    <span class="c1"># Greenwave</span>
    <span class="n">test_gating_status</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Koji tag, if any, from which the list of builds was populated initially.</span>
    <span class="n">from_tag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Update.</span>

<span class="sd">        We use this as a way to inject an alias into the Update, since it is a required field and</span>
<span class="sd">        we don&#39;t want callers to have to generate the alias themselves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Let&#39;s give this Update an alias so the DB doesn&#39;t become displeased with us.</span>
        <span class="k">if</span> <span class="s1">&#39;release&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must specify a Release when creating an Update.&#39;</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id_prefix</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Update</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Set alias for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_title</span><span class="p">(),</span> <span class="n">alias</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ready_for_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a SHA1 hash of the Builds NVRs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: a SHA1 hash of the builds NVRs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nvrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">nvr</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">]</span>
        <span class="n">builds</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">nvrs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">builds</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="c1"># WARNING: consumers/composer.py assumes that this validation is performed!</span>
<div class="viewcode-block" id="Update.validate_builds"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.validate_builds">[docs]</a>    <span class="nd">@validates</span><span class="p">(</span><span class="s1">&#39;builds&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_builds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">build</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate builds being appended to ensure they are all the same type.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The field&#39;s key, which is un-used in this validator.</span>
<span class="sd">            build (Build): The build object which was appended to the list</span>
<span class="sd">                of builds.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the build being appended is not the same type as the</span>
<span class="sd">                existing builds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">build</span><span class="p">))</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;An update must contain builds of the same type.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">build</span></div>

<div class="viewcode-block" id="Update.validate_release"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.validate_release">[docs]</a>    <span class="nd">@validates</span><span class="p">(</span><span class="s1">&#39;release&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">release</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure the release is the same content type as this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The field&#39;s key, which is un-used in this validator.</span>
<span class="sd">            release (Release): The release object which is being associated with this update.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the release being associated is not the same content type as the</span>
<span class="sd">                update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">release</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">Update</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Update</span><span class="o">.</span><span class="n">release_id</span> <span class="o">==</span> <span class="n">release</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Update</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">content_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A release must contain updates of the same type.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">release</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">date_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the time that this update became locked.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.datetime or None: The time this update became locked, or None if it is not</span>
<span class="sd">                locked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose</span><span class="o">.</span><span class="n">date_created</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">date_pushed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the time that this update was pushed in repository.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.datetime or None: The most recent between date_testing and date_stable, or</span>
<span class="sd">                None if the update was never pushed in any repo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_stable</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_stable</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_testing</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_testing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mandatory_days_in_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate and return how many days an update should be in testing before becoming stable.</span>

<span class="sd">        :return: The number of mandatory days in testing.</span>
<span class="sd">        :rtype:  int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">critpath_mandatory_days_in_testing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">karma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate and return the karma for the Update.</span>

<span class="sd">        :return: The Update&#39;s current karma.</span>
<span class="sd">        :rtype:  int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">positive_karma</span><span class="p">,</span> <span class="n">negative_karma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composite_karma</span>
        <span class="k">return</span> <span class="n">positive_karma</span> <span class="o">+</span> <span class="n">negative_karma</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_composite_karma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate and return a 2-tuple of the positive and negative karma.</span>

<span class="sd">        Sums the positive karma comments, and then sums the negative karma comments. The total karma</span>
<span class="sd">        is simply the sum of the two elements of this 2-tuple.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 2-tuple of (positive_karma, negative_karma).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">positive_karma</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">negative_karma</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">users_counted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments_since_karma_reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">karma</span> <span class="ow">and</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_counted</span><span class="p">:</span>
                <span class="c1"># Make sure we only count the last comment this user made</span>
                <span class="n">users_counted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">positive_karma</span> <span class="o">+=</span> <span class="n">comment</span><span class="o">.</span><span class="n">karma</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">negative_karma</span> <span class="o">+=</span> <span class="n">comment</span><span class="o">.</span><span class="n">karma</span>

        <span class="k">return</span> <span class="n">positive_karma</span><span class="p">,</span> <span class="n">negative_karma</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comments_since_karma_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the comments since the most recent karma reset event.</span>

<span class="sd">        Karma is reset when :class:`Builds &lt;Build&gt;` are added or removed from an update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: class:`Comments &lt;Comment&gt;` since the karma reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We want to traverse the comments in reverse order so we only consider</span>
        <span class="c1"># the most recent comments from any given user and only the comments</span>
        <span class="c1"># since the most recent karma reset event.</span>
        <span class="n">comments_since_karma_reset</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;bodhi&#39;</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="s1">&#39;New build&#39;</span> <span class="ow">in</span> <span class="n">comment</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;Removed build&#39;</span> <span class="ow">in</span> <span class="n">comment</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                <span class="c1"># We only want to consider comments since the most recent karma</span>
                <span class="c1"># reset, which happens whenever a build is added or removed</span>
                <span class="c1"># from an Update. Since we are traversing the comments in</span>
                <span class="c1"># reverse order, once we find one of these comments we can</span>
                <span class="c1"># simply exit this loop.</span>
                <span class="k">break</span>
            <span class="n">comments_since_karma_reset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">comments_since_karma_reset</span>

<div class="viewcode-block" id="Update.get_critpath_groups"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_critpath_groups">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_critpath_groups</span><span class="p">(</span><span class="n">builds</span><span class="p">,</span> <span class="n">release_branch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine which (if any) critpath groups the builds passed in are part of.</span>

<span class="sd">        Args:</span>
<span class="sd">            builds (list): :class:`Builds &lt;Build&gt;` to be considered.</span>
<span class="sd">            release_branch (str): The name of the git branch associated to the release,</span>
<span class="sd">                such as &quot;f25&quot; or &quot;master&quot;.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A space-separated list of the critpath groups. Will be empty if none.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the configured critpath.type does not list by group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">build_names_by_type</span><span class="p">(</span><span class="n">builds</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">get_grouped_critpath_components</span><span class="p">(</span>
                    <span class="n">release_branch</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="n">ptype</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span></div>

<div class="viewcode-block" id="Update.contains_critpath_component"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.contains_critpath_component">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">contains_critpath_component</span><span class="p">(</span><span class="n">builds</span><span class="p">,</span> <span class="n">release_branch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if there is a critpath component in the builds passed in.</span>

<span class="sd">        Args:</span>
<span class="sd">            builds (list): :class:`Builds &lt;Build&gt;` to be considered.</span>
<span class="sd">            release_branch (str): The name of the git branch associated to the release,</span>
<span class="sd">                such as &quot;f25&quot; or &quot;master&quot;.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if the update contains a critical path package, ``False`` otherwise.</span>
<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the PDC did not give us a 200 code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">build_names_by_type</span><span class="p">(</span><span class="n">builds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_critpath_components</span><span class="p">(</span><span class="n">release_branch</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="n">ptype</span><span class="p">])):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">greenwave_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Form and return the proper Greenwave API subject field for this Update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of dictionaries that are appropriate to be passed to the Greenwave API</span>
<span class="sd">                subject field for a decision about this Update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># See discussion on https://pagure.io/greenwave/issue/34 for why we use these subjects.</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;koji_build&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">]</span>
        <span class="n">subject</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bodhi_update&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">subject</span>

<div class="viewcode-block" id="Update.greenwave_request_batches"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.greenwave_request_batches">[docs]</a>    <span class="k">def</span> <span class="nf">greenwave_request_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Form and return the proper Greenwave API requests data for this Update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of dictionaries that are appropriate to be passed to the Greenwave API</span>
<span class="sd">                for a decision about this Update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greenwave_subject_batch_size</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">subjects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greenwave_subject</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;product_version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_version</span><span class="p">,</span>
                <span class="s1">&#39;decision_context&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greenwave_decision_contexts</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">subjects</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span>
                <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">greenwave_request_batches_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Form and return the proper Greenwave API requests data for this Update as JSON.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A JSON list of objects that are appropriate to be passed to the Greenwave</span>
<span class="sd">                API for a decision about this Update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">greenwave_request_batches</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">greenwave_subject_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maximum number of subjects in single Greenwave request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;greenwave_batch_size&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_greenwave_api_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;greenwave_api_url&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="s1">&#39;No greenwave_api_url specified&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/decision&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;greenwave_api_url&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_greenwave_decision_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return greenwave contexts that should be queried for this update.</span>

<span class="sd">        The base context depends whether the update is going to</span>
<span class="sd">        testing (status=pending) or to stable (status=testing). We</span>
<span class="sd">        also query on additional contexts for critpath updates. If the</span>
<span class="sd">        critpath type provides grouped information, we query on one</span>
<span class="sd">        additional context per critpath group represented in the</span>
<span class="sd">        update&#39;s packages. If it does not, we query on the catch-all</span>
<span class="sd">        additional &#39;critpath&#39; context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this is correct if update is already in testing...</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bodhi_update_push_stable&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">:</span>
            <span class="c1"># ...but if it is pending, we want to know if it can go to testing</span>
            <span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bodhi_update_push_testing&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath_groups</span><span class="p">:</span>
            <span class="n">ocontext</span> <span class="o">=</span> <span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath_groups</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
                <span class="n">contexts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ocontext</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_critpath&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath</span><span class="p">:</span>
            <span class="n">contexts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_critpath&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contexts</span>

<div class="viewcode-block" id="Update.get_test_gating_info"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_test_gating_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_test_gating_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query Greenwave about this update and return the information retrieved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of response dicts from Greenwave for this update.</span>
<span class="sd">        Raises:</span>
<span class="sd">            BodhiException: When the ``greenwave_api_url`` is undefined in configuration.</span>
<span class="sd">            RuntimeError: If Greenwave did not give us a 200 code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">util</span><span class="o">.</span><span class="n">greenwave_api_post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greenwave_api_url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">greenwave_request_batches</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_greenwave_requirements_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query Greenwave about this update and return satisfied and unsatisfied requirements.</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator: An iterable of 2-tuples of lists of requirement dicts from each request</span>
<span class="sd">            batch: first tuple item satisfied requirements, second item unsatisfied requirements.</span>
<span class="sd">            Either list or both may be empty.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BodhiException: When the ``greenwave_api_url`` is undefined in configuration.</span>
<span class="sd">            RuntimeError: If Greenwave did not give us a 200 code, including if no applicable</span>
<span class="sd">            policies were found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">greenwave_request_batches</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">greenwave_api_post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greenwave_api_url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">satisfied</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;satisfied_requirements&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">unsatisfied</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unsatisfied_requirements&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">satisfied</span><span class="p">,</span> <span class="n">unsatisfied</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_unsatisfied_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query Greenwave about this update and return all unsatisfied requirements.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of unsatisfied requirement dicts.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BodhiException: When the ``greenwave_api_url`` is undefined in configuration.</span>
<span class="sd">            RuntimeError: If Greenwave did not give us a 200 code, including if no applicable</span>
<span class="sd">            policies were found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">unsatisfied</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greenwave_requirements_generator</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unsatisfied</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_get_test_gating_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query Greenwave about this update and return the information retrieved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TestGatingStatus:</span>
<span class="sd">                - TestGatingStatus.ignored if no tests are required</span>
<span class="sd">                - TestGatingStatus.passed if there are required tests and policies are satisfied</span>
<span class="sd">                - TestGatingStatus.waiting if there are required tests that have not yet completed,</span>
<span class="sd">                  no required test has failed, and update was last modified less than 2 hours ago</span>
<span class="sd">                - TestGatingStatus.failed otherwise (failed required tests, missing required</span>
<span class="sd">                  test results and last modified more than 2 hours ago)</span>

<span class="sd">        Raises:</span>
<span class="sd">            BodhiException: When the ``greenwave_api_url`` is undefined in configuration.</span>
<span class="sd">            RuntimeError: If Greenwave did not give us a 200 code, including if no applicable</span>
<span class="sd">            policies were found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gotsat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gotunsat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">satisfied</span><span class="p">,</span> <span class="n">unsatisfied</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greenwave_requirements_generator</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">satisfied</span><span class="p">:</span>
                <span class="n">gotsat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">unsatisfied</span><span class="p">:</span>
                <span class="n">gotunsat</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">recent</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;test-result-missing&#39;</span>
                                         <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">unsatisfied</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">failed</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gotsat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">gotunsat</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">ignored</span>

        <span class="k">if</span> <span class="n">gotsat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">gotunsat</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">passed</span>

        <span class="c1"># here, we have unsatisfied requirements but we never bailed early</span>
        <span class="c1"># in the for loop, so they are all &#39;missing&#39; and update was recently modified</span>
        <span class="k">return</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">waiting</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">install_command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the appropriate command for installing the Update.</span>

<span class="sd">        There are four conditions under which the empty string is returned:</span>
<span class="sd">            * If the update is in testing status for rawhide.</span>
<span class="sd">            * If the update is not in a stable or testing repository.</span>
<span class="sd">            * If the release has not specified a package manager.</span>
<span class="sd">            * If the release has not specified a testing repository.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The dnf command to install the Update, or the empty string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">stable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">package_manager</span> <span class="o">==</span> <span class="n">PackageManager</span><span class="o">.</span><span class="n">unspecified</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">testing_repository</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;sudo </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}{}{}</span><span class="s1"> --advisory=</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">package_manager</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;install&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">newpackage</span> <span class="k">else</span> <span class="s1">&#39;upgrade&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39; --enablerepo=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">testing_repository</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39; --refresh&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">package_manager</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;dnf&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39; \*&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">newpackage</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>

<div class="viewcode-block" id="Update.update_test_gating_status"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.update_test_gating_status">[docs]</a>    <span class="k">def</span> <span class="nf">update_test_gating_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query Greenwave about this update and set the test_gating_status as appropriate.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_test_gating_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># If we receive a 500 error code from Greenwave, we set the test_gating_status to</span>
            <span class="c1"># waiting. The status will then be updated later by the greenwave fedora-messaging</span>
            <span class="c1"># consumer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_status</span> <span class="o">=</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">waiting</span></div>

<div class="viewcode-block" id="Update.new"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.new">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new update.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (pyramid.request.Request): The current web request.</span>
<span class="sd">            data (dict): A key-value mapping of the new update&#39;s attributes.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 2-tuple of the edited update and a list of dictionaries that describe caveats.</span>
<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the PDC did not give us a 200 code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">caveats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_critpath_groups</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">branch</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath_groups&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains_critpath_component</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">branch</span><span class="p">)</span>

        <span class="c1"># Be sure to not add an empty string as alternative title</span>
        <span class="c1"># and strip whitespaces from it</span>
        <span class="k">if</span> <span class="s1">&#39;display_name&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Create the Bug entities, but don&#39;t talk to rhbz yet.  We do that</span>
        <span class="c1"># offline in the UpdatesHandler task worker now.</span>
        <span class="n">bugs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bugs&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">bug_num</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bugs&#39;</span><span class="p">]:</span>
                <span class="n">bug</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Bug</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">bug_id</span><span class="o">=</span><span class="n">bug_num</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bug</span><span class="p">:</span>
                    <span class="n">bug</span> <span class="o">=</span> <span class="n">Bug</span><span class="p">(</span><span class="n">bug_id</span><span class="o">=</span><span class="n">bug_num</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">bugs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bugs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bugs</span>

        <span class="c1"># If no requirements are provided, then gather some defaults from the</span>
        <span class="c1"># packages of the associated builds.</span>
        <span class="c1"># See https://github.com/fedora-infra/bodhi/issues/101</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;requirements&#39;</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;requirements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">requirements</span><span class="p">))</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">build</span><span class="o">.</span><span class="n">package</span> <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">]</span>
                <span class="p">]</span> <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">requirements</span><span class="p">],</span> <span class="p">[]))))</span>

        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;edited&#39;</span><span class="p">]</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">)</span>

        <span class="c1"># Create the update</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating new Update(**data) object.&quot;</span><span class="p">)</span>
        <span class="n">release</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span><span class="p">:</span>
            <span class="c1"># For rawhide updates make sure autotime push is enabled</span>
            <span class="c1"># https://github.com/fedora-infra/bodhi/issues/3912</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;autotime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stable_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Overriding autotime settings for rawhide update.&quot;</span><span class="p">)</span>

        <span class="n">up</span> <span class="o">=</span> <span class="n">Update</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="n">release</span><span class="p">)</span>

        <span class="c1"># We want to make sure that the value of stable_days</span>
        <span class="c1"># will not be lower than the mandatory_days_in_testing.</span>
        <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span> <span class="o">&gt;</span> <span class="n">up</span><span class="o">.</span><span class="n">stable_days</span><span class="p">:</span>
            <span class="n">up</span><span class="o">.</span><span class="n">stable_days</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span>
            <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;stable days&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;The number of stable days required was set to the mandatory &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;release value of </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span><span class="si">}</span><span class="s2"> days&quot;</span>
            <span class="p">})</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding new update to the db </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">up</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Triggering db commit for new update </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deferring working on bugs and fetching test cases to celery&quot;</span><span class="p">)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">alias</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bodhi_email&#39;</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not configured to handle bugs&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bug_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span> <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="n">up</span><span class="o">.</span><span class="n">bugs</span><span class="p">]</span>
            <span class="n">work_on_bugs_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">bug_ids</span><span class="p">)</span>

        <span class="n">fetch_test_cases_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="c1"># track whether to set gating status shortly...</span>
        <span class="n">setgs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">)</span>
        <span class="c1"># The request to testing for side-tag updates is set within the signed consumer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from_tag&quot;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting request for new update </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">up</span><span class="o">.</span><span class="n">set_request</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">req</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                <span class="c1"># set_request will update gating status if necessary</span>
                <span class="n">setgs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">setgs</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Test gating required is enforced, marking the update as waiting on test gating&#39;</span><span class="p">)</span>
            <span class="n">up</span><span class="o">.</span><span class="n">test_gating_status</span> <span class="o">=</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">waiting</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done with Update.new(...) </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">up</span><span class="p">,</span> <span class="n">caveats</span></div>

<div class="viewcode-block" id="Update.edit"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.edit">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Edit the update.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (pyramid.request.Request): The current web request.</span>
<span class="sd">            data (dict): A key-value mapping of what should be altered in this update.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 2-tuple of the edited update and a list of dictionaries that describe caveats.</span>
<span class="sd">        Raises:</span>
<span class="sd">            LockedUpdateException: If the update is locked.</span>
<span class="sd">            RuntimeError: If the PDC did not give us a 200 code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span>
        <span class="n">buildinfo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">buildinfo</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Update</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;edited&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;edited&#39;</span><span class="p">]</span>

        <span class="n">caveats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edited_builds</span> <span class="o">=</span> <span class="p">[</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span> <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">up</span><span class="o">.</span><span class="n">builds</span><span class="p">]</span>

        <span class="c1"># Be sure to not add an empty string as alternative title</span>
        <span class="c1"># and strip whitespaces from it</span>
        <span class="k">if</span> <span class="s1">&#39;display_name&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># stable_days can be set by the user. We want to make sure that the value</span>
        <span class="c1"># will not be lower than the mandatory_days_in_testing.</span>
        <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stable_days&#39;</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">stable_days</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stable_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span>
            <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;stable days&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;The number of stable days required was raised to the mandatory &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;release value of </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span><span class="si">}</span><span class="s2"> days&quot;</span>
            <span class="p">})</span>

        <span class="c1"># Determine which builds have been added</span>
        <span class="n">new_builds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">build</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edited_builds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LockedUpdateException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t add builds to a &quot;</span>
                                                <span class="s2">&quot;locked update&quot;</span><span class="p">)</span>

                <span class="n">new_builds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>
                <span class="n">Package</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">buildinfo</span><span class="p">[</span><span class="n">build</span><span class="p">])</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Build</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">nvr</span><span class="o">=</span><span class="n">build</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                <span class="n">up</span><span class="o">.</span><span class="n">builds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="c1"># Determine which builds have been removed</span>
        <span class="n">removed_builds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">edited_builds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">build</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LockedUpdateException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t remove builds from a &quot;</span>
                                                <span class="s2">&quot;locked update&quot;</span><span class="p">)</span>

                <span class="n">removed_builds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">up</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">nvr</span> <span class="o">==</span> <span class="n">build</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="n">b</span><span class="o">.</span><span class="n">unpush</span><span class="p">(</span><span class="n">koji</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">koji</span><span class="p">,</span> <span class="n">from_side_tag</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">from_tag</span><span class="p">))</span>
                <span class="n">up</span><span class="o">.</span><span class="n">builds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

                <span class="c1"># Expire any associated buildroot override</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">override</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expiring BRO for </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s2"> because the build is unpushed.&quot;</span><span class="p">)</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">override</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Only delete the Build entity if it isn&#39;t associated with</span>
                    <span class="c1"># an override</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_critpath_groups</span><span class="p">(</span>
                <span class="n">up</span><span class="o">.</span><span class="n">builds</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">branch</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath_groups&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;critpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains_critpath_component</span><span class="p">(</span>
                <span class="n">up</span><span class="o">.</span><span class="n">builds</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">branch</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">]</span>

        <span class="c1"># Comment on the update with details of added/removed builds</span>
        <span class="c1"># .. enumerate the builds in markdown format so they&#39;re pretty.</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> edited this update.&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">new_builds</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">New build(s):</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">new_build</span> <span class="ow">in</span> <span class="n">new_builds</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_build</span>
        <span class="k">if</span> <span class="n">removed_builds</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Removed build(s):</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">removed_build</span> <span class="ow">in</span> <span class="n">removed_builds</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">removed_build</span>
        <span class="k">if</span> <span class="n">new_builds</span> <span class="ow">or</span> <span class="n">removed_builds</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Karma has been reset.&#39;</span>
        <span class="n">up</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">karma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>
        <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;builds&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">})</span>

        <span class="c1"># Updates with new or removed builds always go back to testing</span>
        <span class="k">if</span> <span class="n">new_builds</span> <span class="ow">or</span> <span class="n">removed_builds</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span>
            <span class="c1"># And, updates with new or removed builds always get their karma reset.</span>
            <span class="c1"># https://github.com/fedora-infra/bodhi/issues/511</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;karma_critipath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">up</span><span class="o">.</span><span class="n">date_testing</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">up</span><span class="o">.</span><span class="n">from_tag</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span> <span class="ow">and</span> <span class="n">up</span><span class="o">.</span><span class="n">from_tag</span>
                    <span class="ow">and</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># Remove all koji tags and change the status back to pending</span>
                <span class="n">up</span><span class="o">.</span><span class="n">unpush</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Builds changed.  Your update is being &#39;</span>
                    <span class="s1">&#39;sent back to testing.&#39;</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">builds_to_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">nvr</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">up</span><span class="o">.</span><span class="n">builds</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No need to unpush the update, just tag new builds</span>
                <span class="c1"># into the appropriate pending-signing tag</span>
                <span class="c1"># and release-candidate tag if builds are in side-tag</span>
                <span class="n">builds_to_tag</span> <span class="o">=</span> <span class="n">new_builds</span>

            <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">from_tag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">get_pending_signing_side_tag</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">from_tag</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">up</span><span class="o">.</span><span class="n">from_tag</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span><span class="p">:</span>
                    <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For normal updates the builds already have candidate_tag</span>
                <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">tag_update_builds_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">builds</span><span class="o">=</span><span class="n">builds_to_tag</span><span class="p">)</span>

        <span class="n">new_bugs</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">update_bugs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bugs&#39;</span><span class="p">],</span> <span class="n">db</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bugs&#39;</span><span class="p">]</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span><span class="p">:</span>
            <span class="n">up</span><span class="o">.</span><span class="n">set_request</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">up</span><span class="o">.</span><span class="n">date_modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateEditV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;update&#39;</span><span class="p">:</span> <span class="n">up</span><span class="p">,</span> <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;new_bugs&#39;</span><span class="p">:</span> <span class="n">new_bugs</span><span class="p">}))</span>

        <span class="c1"># If editing a Pending update, all of whose builds are signed, for a release</span>
        <span class="c1"># which isn&#39;t composed by Bodhi (i.e. Rawhide), move it directly to Testing.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">up</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span> <span class="ow">and</span> <span class="n">up</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span> \
                <span class="ow">and</span> <span class="n">up</span><span class="o">.</span><span class="n">signed</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Every build in the update is signed, set status to testing&quot;</span><span class="p">)</span>
            <span class="n">up</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span>
            <span class="n">up</span><span class="o">.</span><span class="n">date_testing</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()</span>
            <span class="n">up</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update status of </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2"> has been set to testing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating test gating status of </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">up</span><span class="o">.</span><span class="n">update_test_gating_status</span><span class="p">()</span>

        <span class="c1"># Commit the changes in the db before calling celery tasks.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deferring working on bugs and fetching test cases to celery&quot;</span><span class="p">)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">alias</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bodhi_email&#39;</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not configured to handle bugs&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work_on_bugs_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">new_bugs</span><span class="p">)</span>

        <span class="n">fetch_test_cases_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done editing </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">up</span><span class="p">,</span> <span class="n">caveats</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether the update is considered signed or not.</span>

<span class="sd">        This will return ``True`` if all :class:`Builds &lt;Build&gt;` associated with this update are</span>
<span class="sd">        signed, or if the associated :class:`Release` does not have a ``pending_signing_tag``</span>
<span class="sd">        defined. Otherwise, it will return ``False``.</span>

<span class="sd">        If the update is created ``from_tag`` always check if every build is signed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if the update is signed, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_tag</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">build</span><span class="o">.</span><span class="n">signed</span> <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the ContentType associated with this update.</span>

<span class="sd">        If the update has no :class:`Builds &lt;Build&gt;`, this evaluates to ``None``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ContentType or None: The content type of this update or ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">test_gating_passed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a boolean representing if this update has passed the test gating.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the Update&#39;s test_gating_status property is None,</span>
<span class="sd">            ignored, or passed. Otherwise it returns False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_status</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">ignored</span><span class="p">,</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">passed</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Update.obsolete_older_updates"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.obsolete_older_updates">[docs]</a>    <span class="k">def</span> <span class="nf">obsolete_older_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obsolete any older pending/testing updates.</span>

<span class="sd">        If a build is associated with multiple updates, make sure that</span>
<span class="sd">        all updates are safe to obsolete, or else just skip it.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: A list of dictionaries that describe caveats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caveats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">oldBuild</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Build</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Update</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">and_</span><span class="p">(</span><span class="n">Build</span><span class="o">.</span><span class="n">nvr</span> <span class="o">!=</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span>
                     <span class="n">Build</span><span class="o">.</span><span class="n">package</span> <span class="o">==</span> <span class="n">build</span><span class="o">.</span><span class="n">package</span><span class="p">,</span>
                     <span class="n">Update</span><span class="o">.</span><span class="n">locked</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">Update</span><span class="o">.</span><span class="n">release</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">,</span>
                     <span class="n">or_</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">Update</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">,</span>
                                  <span class="n">Update</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">),</span>
                              <span class="n">or_</span><span class="p">(</span><span class="n">Update</span><span class="o">.</span><span class="n">request</span> <span class="o">!=</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">,</span>
                                  <span class="n">Update</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">))),</span>
                         <span class="n">and_</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">Update</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">,</span>
                                  <span class="n">Update</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">),</span>
                              <span class="n">Update</span><span class="o">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">)))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">obsoletable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">nvr</span> <span class="o">=</span> <span class="n">build</span><span class="o">.</span><span class="n">get_n_v_r</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">rpm</span><span class="o">.</span><span class="n">labelCompare</span><span class="p">(</span><span class="n">oldBuild</span><span class="o">.</span><span class="n">get_n_v_r</span><span class="p">(),</span> <span class="n">nvr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is newer than </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nvr</span><span class="p">,</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">nvr</span><span class="p">))</span>
                    <span class="n">obsoletable</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Ensure that all of the packages in the old update are</span>
                <span class="c1"># present in the new one.</span>
                <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">_build</span> <span class="ow">in</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_build</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
                        <span class="n">obsoletable</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="c1"># Warn if you&#39;re stomping on another user but don&#39;t necessarily</span>
                <span class="c1"># obsolete them</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">builds</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Please be aware that there &#39;</span>
                            <span class="s1">&#39;is another update in flight owned by </span><span class="si">%s</span><span class="s1">, &#39;</span>
                            <span class="s1">&#39;containing </span><span class="si">%s</span><span class="s1">. Are you coordinating with &#39;</span>
                            <span class="s1">&#39;them?&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">oldBuild</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">})</span>

                <span class="c1"># Warn about attempt to obsolete security update by update with</span>
                <span class="c1"># other type and set type of new update to security.</span>
                <span class="k">if</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span><span class="p">:</span>
                    <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Adjusting type of this update to security,&#39;</span>
                        <span class="s1">&#39;since it obsoletes another security update&#39;</span>
                    <span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">severity</span> <span class="o">=</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">severity</span>

                <span class="k">if</span> <span class="n">obsoletable</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is obsoletable&#39;</span> <span class="o">%</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>

                    <span class="c1"># Have the newer update inherit the older updates bugs</span>
                    <span class="n">oldbugs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span> <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">bugs</span><span class="p">]</span>
                    <span class="n">bugs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span> <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_bugs</span><span class="p">(</span><span class="n">bugs</span> <span class="o">+</span> <span class="n">oldbugs</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

                    <span class="c1"># Also inherit the older updates notes as well and</span>
                    <span class="c1"># add a markdown separator between the new and old ones.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">notes</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">----</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">notes</span>
                    <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">obsolete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">newer</span><span class="o">=</span><span class="n">build</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;This update has obsoleted </span><span class="si">%s</span><span class="s1">, and has &#39;</span>
                                <span class="s1">&#39;inherited its bugs and notes.&#39;</span><span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">](</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldBuild</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span>
                                         <span class="n">oldBuild</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">abs_url</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">template</span> <span class="o">%</span> <span class="n">link</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>
                    <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">template</span> <span class="o">%</span> <span class="n">oldBuild</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">caveats</span></div>

<div class="viewcode-block" id="Update.get_tags"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_tags">[docs]</a>    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all koji tags for all builds on this update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: strings of the koji tags used in this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">],</span> <span class="p">[])))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Update&#39;s title.</span>

<span class="sd">        This is just an alias for get_title with default parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>

<div class="viewcode-block" id="Update.get_title"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_title">[docs]</a>    <span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delim</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">after_limit</span><span class="o">=</span><span class="s1">&#39;â¦&#39;</span><span class="p">,</span>
                  <span class="n">beautify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nvr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a title for the update based on the :class:`Builds &lt;Build&gt;` it is associated with.</span>

<span class="sd">        Args:</span>
<span class="sd">            delim (str): The delimiter used to separate the builds. Defaults to &#39; &#39;.</span>
<span class="sd">            limit (int or None): If provided, limit the number of builds included to the given</span>
<span class="sd">                number. If ``None`` (the default), no limit is used.</span>
<span class="sd">            after_limit (str): If a limit is set, use this string after the limit is reached.</span>
<span class="sd">                Defaults to &#39;â¦&#39;.</span>
<span class="sd">            beautify (bool): If provided, the returned string will be human</span>
<span class="sd">                readable, i.e. 3 or more builds will take the form &quot;package1,</span>
<span class="sd">                package2 and XXX more&quot;.</span>
<span class="sd">            nvr (bool): If specified, the title will include name, version and</span>
<span class="sd">                release information in package labels.</span>
<span class="sd">            amp (bool): If specified, it will replace the word &#39;and&#39; with an</span>
<span class="sd">                ampersand, &#39;&amp;&#39;.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A title for this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beautify</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span>

            <span class="k">def</span> <span class="nf">build_label</span><span class="p">(</span><span class="n">build</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span> <span class="k">if</span> <span class="n">nvr</span> <span class="k">else</span> <span class="n">build</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">name</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">build_label</span><span class="p">(</span><span class="n">build</span><span class="p">)</span> <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">[:</span><span class="mi">2</span><span class="p">]])</span>

                <span class="k">if</span> <span class="n">amp</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;, &amp; &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;, and &quot;</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot; more&quot;</span>

                <span class="k">return</span> <span class="n">title</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">build_label</span><span class="p">(</span><span class="n">build</span><span class="p">)</span> <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span>
            <span class="n">all_nvrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">nvr</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">]</span>
            <span class="n">nvrs</span> <span class="o">=</span> <span class="n">all_nvrs</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
            <span class="n">builds</span> <span class="o">=</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">nvrs</span><span class="p">))</span> <span class="o">+</span> \
                <span class="p">(</span><span class="n">after_limit</span> <span class="k">if</span> <span class="n">limit</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nvrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">builds</span></div>

<div class="viewcode-block" id="Update.get_bugstring"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_bugstring">[docs]</a>    <span class="k">def</span> <span class="nf">get_bugstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_titles</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a space-delimited string of bug numbers for this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            show_titles (bool): If True, include the bug titles in the output. If False, include</span>
<span class="sd">                only bug ids.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A space separated list of bugs associated with this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">show_titles</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">:</span>
                <span class="n">bugstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1"> - </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">i</span> <span class="ow">and</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span><span class="p">,</span> <span class="n">bug</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span>
                    <span class="n">bugstr</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">67</span><span class="p">,</span>
                    <span class="n">subsequent_indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Update.get_bug_karma"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_bug_karma">[docs]</a>    <span class="k">def</span> <span class="nf">get_bug_karma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bug</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the karma for this update for the given bug.</span>

<span class="sd">        Args:</span>
<span class="sd">            bug (Bug): The bug we want the karma about.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 2-tuple of integers. The first represents negative karma, the second represents</span>
<span class="sd">            positive karma.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">good</span><span class="p">,</span> <span class="n">bad</span><span class="p">,</span> <span class="n">seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments_since_karma_reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="n">comment</span><span class="o">.</span><span class="n">bug_feedback</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">bug</span> <span class="o">==</span> <span class="n">bug</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">good</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">feedback</span><span class="o">.</span><span class="n">karma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">bad</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">bad</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">good</span></div>

<div class="viewcode-block" id="Update.get_testcase_karma"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_testcase_karma">[docs]</a>    <span class="k">def</span> <span class="nf">get_testcase_karma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testcase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the karma for this update for the given TestCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            testcase (TestCase): The TestCase we want the karma about.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A 2-tuple of integers. The first represents negative karma, the second represents</span>
<span class="sd">            positive karma.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">good</span><span class="p">,</span> <span class="n">bad</span><span class="p">,</span> <span class="n">seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments_since_karma_reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="n">comment</span><span class="o">.</span><span class="n">unique_testcase_feedback</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">testcase</span> <span class="o">==</span> <span class="n">testcase</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">good</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">feedback</span><span class="o">.</span><span class="n">karma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">bad</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">bad</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">good</span></div>

<div class="viewcode-block" id="Update.set_request"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.set_request">[docs]</a>    <span class="k">def</span> <span class="nf">set_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the update&#39;s request to the given action.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">            action (UpdateRequest or str): The desired request. May be expressed as an</span>
<span class="sd">                UpdateRequest instance, or as a string describing the desired request.</span>
<span class="sd">            username (str): The username of the user making the request.</span>
<span class="sd">        Raises:</span>
<span class="sd">            BodhiException: Two circumstances can raise this ``Exception``:</span>

<span class="sd">                * If the user tries to push a critical path update directly from pending to stable.</span>
<span class="sd">                * If the update doesn&#39;t meet testing requirements.</span>

<span class="sd">            LockedUpdateException: If the update is locked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Attempting to set request </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="n">action</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> already </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has already been submitted to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LockedUpdateException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t change the request on a &quot;</span>
                                        <span class="s2">&quot;locked update&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span> \
                <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="p">(</span><span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span> <span class="ow">or</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="s1">&#39;Setting a request on an Update for a Release &#39;</span>
                                 <span class="s1">&#39;not composed by Bodhi is not allowed&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">unpush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpush</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;This update has been unpushed.&#39;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestUnpushV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">username</span><span class="p">)))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been unpushed.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been obsoleted.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestObsoleteV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">username</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="c1"># If status is pending going to testing request and action is revoke,</span>
        <span class="c1"># set the status to unpushed</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span> \
                <span class="ow">and</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">revoke</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">unpushed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been revoked.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestRevokeV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">username</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="c1"># If status is testing going to stable request and action is revoke,</span>
        <span class="c1"># keep the status at testing</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">revoke</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been revoked.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestRevokeV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">username</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">revoke</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been revoked.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestRevokeV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">username</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="c1"># Disable pushing updates from pending directly to stable when the release is frozen</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">action</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ReleaseState</span><span class="o">.</span><span class="n">frozen</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span>
                <span class="s1">&#39;The release of this update is frozen and the update has not yet been &#39;</span>
                <span class="s1">&#39;pushed to testing. It is currently not possible to push it to stable.&#39;</span><span class="p">)</span>

        <span class="c1"># Disable pushing critical path updates for pending releases directly to stable</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.num_admin_approvals&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath_approved</span><span class="p">:</span>
                    <span class="n">stern_note</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;This critical path update has not yet been approved for pushing to the &#39;</span>
                        <span class="s1">&#39;stable repository.  It must first reach a karma of </span><span class="si">%s</span><span class="s1">, consisting of </span><span class="si">%s</span><span class="s1"> &#39;</span>
                        <span class="s1">&#39;positive karma from proventesters, along with </span><span class="si">%d</span><span class="s1"> additional karma from &#39;</span>
                        <span class="s1">&#39;the community. Or, it must spend </span><span class="si">%s</span><span class="s1"> days in testing without any negative &#39;</span>
                        <span class="s1">&#39;feedback&#39;</span><span class="p">)</span>
                    <span class="n">additional_karma</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.min_karma&#39;</span><span class="p">)</span> \
                        <span class="o">-</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.num_admin_approvals&#39;</span><span class="p">)</span>
                    <span class="n">stern_note</span> <span class="o">=</span> <span class="n">stern_note</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.min_karma&#39;</span><span class="p">),</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.num_admin_approvals&#39;</span><span class="p">),</span>
                        <span class="n">additional_karma</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.stable_after_days_without_negative_karma&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">):</span>
                        <span class="n">stern_note</span> <span class="o">+=</span> <span class="s1">&#39; Additionally, it must pass automated tests.&#39;</span>
                    <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stern_note</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="s1">&#39;. &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notes</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Forcing critical path update into testing&#39;</span><span class="p">)</span>
                        <span class="n">action</span> <span class="o">=</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span>

        <span class="c1"># Ensure this update meets the minimum testing requirements</span>
        <span class="n">flash_notes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath</span><span class="p">:</span>
            <span class="c1"># Check if we&#39;ve met the karma requirements</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_karma</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath_approved</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> meets stable karma requirements&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If we haven&#39;t met the stable karma requirements, check if it</span>
                <span class="c1"># has met the mandatory time-in-testing requirements</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_stable_comment</span> <span class="ow">and</span> \
                       <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">meets_testing_requirements</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">id_prefix</span> <span class="o">==</span> <span class="s2">&quot;FEDORA-EPEL&quot;</span><span class="p">:</span>
                            <span class="n">flash_notes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;not_yet_tested_epel_msg&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">flash_notes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;not_yet_tested_msg&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="n">flash_notes</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="n">flash_notes</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">action</span> <span class="o">=</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span>

        <span class="c1"># Add the appropriate &#39;pending&#39; koji tag to this update, so tools like</span>
        <span class="c1"># AutoQA can compose repositories of them for testing.</span>
        <span class="c1"># If it&#39;s a new side-tag update, koji tags are managed by the celery task</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_stable_tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_testing_tag</span><span class="p">)</span>

        <span class="c1"># If an obsolete/unpushed build is being re-submitted, return</span>
        <span class="c1"># it to the pending state, and make sure it&#39;s tagged as a candidate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">UpdateStatus</span><span class="o">.</span><span class="n">obsolete</span><span class="p">,</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">unpushed</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tags</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">action</span>

        <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span> <span class="ow">and</span> <span class="s1">&#39;. &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">flash_notes</span> <span class="o">=</span> <span class="n">flash_notes</span> <span class="ow">and</span> <span class="s1">&#39;. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flash_notes</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been submitted for </span><span class="si">%s</span><span class="s2">. </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">flash_notes</span><span class="p">))</span>

        <span class="n">comment_text</span> <span class="o">=</span> <span class="s1">&#39;This update has been submitted for </span><span class="si">%s</span><span class="s1"> by </span><span class="si">%s</span><span class="s1">. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">action</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>
        <span class="c1"># Add information about push to stable delay to comment when release is frozen.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ReleaseState</span><span class="o">.</span><span class="n">frozen</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="n">comment_text</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">There is an ongoing freeze; this will be &quot;</span>
                <span class="s2">&quot;pushed to stable after the freeze is over. &quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">comment_text</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>

        <span class="n">action_message_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">revoke</span><span class="p">:</span> <span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestRevokeV1</span><span class="p">,</span>
            <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span> <span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestStableV1</span><span class="p">,</span>
            <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span> <span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestTestingV1</span><span class="p">,</span>
            <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">unpush</span><span class="p">:</span> <span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestUnpushV1</span><span class="p">,</span>
            <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span> <span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateRequestObsoleteV1</span><span class="p">}</span>
        <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">action_message_map</span><span class="p">[</span><span class="n">action</span><span class="p">]</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">username</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating test gating status of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_test_gating_status</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsolete_older_updates</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

        <span class="c1"># Commit the changes in the db before calling a celery task.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Update.waive_test_results"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.waive_test_results">[docs]</a>    <span class="k">def</span> <span class="nf">waive_test_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to waive test results for this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            username (str): The name of the user who is waiving the test results.</span>
<span class="sd">            comment (str): A comment from the user describing their decision.</span>
<span class="sd">            tests (list of str): A list of testcases to be waived. Defaults to ``None``</span>
<span class="sd">                If left as ``None``, all ``unsatisfied_requirements`` returned by greenwave</span>
<span class="sd">                will be waived, otherwise only the testcase found in both list will be waived.</span>
<span class="sd">        Raises:</span>
<span class="sd">            LockedUpdateException: If the Update is locked.</span>
<span class="sd">            BodhiException: If test gating is not enabled in this Bodhi instance,</span>
<span class="sd">                            or if the tests have passed.</span>
<span class="sd">            RuntimeError: Either WaiverDB or Greenwave did not give us a 200 code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Attempting to waive test results for this update </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LockedUpdateException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t waive test results on a &quot;</span>
                                        <span class="s2">&quot;locked update&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="s1">&#39;Test gating is not enabled&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_passed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t waive test results on an update that passes test gating&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure we can always iterate over tests</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="n">tests</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsatisfied_requirements</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">tests</span> <span class="ow">and</span> <span class="n">requirement</span><span class="p">[</span><span class="s1">&#39;testcase&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">requirement</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">],</span>
                <span class="s1">&#39;testcase&#39;</span><span class="p">:</span> <span class="n">requirement</span><span class="p">[</span><span class="s1">&#39;testcase&#39;</span><span class="p">],</span>
                <span class="s1">&#39;scenario&#39;</span><span class="p">:</span> <span class="n">requirement</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scenario&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s1">&#39;product_version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_version</span><span class="p">,</span>
                <span class="s1">&#39;waived&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span>
            <span class="p">}</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiving test results: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">waiverdb_api_post</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/waivers/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiverdb_api_url&#39;</span><span class="p">)),</span> <span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_status</span> <span class="o">=</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">waiting</span></div>

<div class="viewcode-block" id="Update.add_tag"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.add_tag">[docs]</a>    <span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the given koji tag to all :class:`Builds &lt;Build&gt;` in this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag (str): The tag to be added to the builds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding tag </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_title</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not adding builds of </span><span class="si">%s</span><span class="s2"> to empty tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># An empty iterator in place of koji multicall</span>

        <span class="n">koji</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="n">koji</span><span class="o">.</span><span class="n">multicall</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="n">koji</span><span class="o">.</span><span class="n">tagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">koji</span><span class="o">.</span><span class="n">multiCall</span><span class="p">()</span></div>

<div class="viewcode-block" id="Update.remove_tag"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.remove_tag">[docs]</a>    <span class="k">def</span> <span class="nf">remove_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">koji</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the given koji tag from all builds in this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag (str): The tag to remove from the :class:`Builds &lt;Build&gt;` in this update.</span>
<span class="sd">            koji (koji.ClientSession or None): A koji client to use to perform the action. If None</span>
<span class="sd">                (the default), this method will use :func:`buildsys.get_session` to get one and</span>
<span class="sd">                multicall will be used.</span>
<span class="sd">        Returns:</span>
<span class="sd">            list or None: If a koji client was provided, ``None`` is returned. Else, a list of tasks</span>
<span class="sd">                from ``koji.multiCall()`` are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removing tag </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_title</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not removing builds of </span><span class="si">%s</span><span class="s2"> from empty tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_title</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># An empty iterator in place of koji multicall</span>

        <span class="n">return_multicall</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">koji</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">koji</span><span class="p">:</span>
            <span class="n">koji</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
            <span class="n">koji</span><span class="o">.</span><span class="n">multicall</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="n">koji</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_multicall</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">koji</span><span class="o">.</span><span class="n">multiCall</span><span class="p">()</span></div>

<div class="viewcode-block" id="Update.find_conflicting_builds"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.find_conflicting_builds">[docs]</a>    <span class="k">def</span> <span class="nf">find_conflicting_builds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find if there are any builds conflicting with the stable tag in the update.</span>

<span class="sd">        Returns a list of conflicting builds, empty is none found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conflicting_builds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">build</span><span class="o">.</span><span class="n">is_latest</span><span class="p">():</span>
                <span class="n">conflicting_builds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conflicting_builds</span></div>

<div class="viewcode-block" id="Update.modify_bugs"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.modify_bugs">[docs]</a>    <span class="k">def</span> <span class="nf">modify_bugs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Comment on and close this update&#39;s bugs as necessary.</span>

<span class="sd">        This typically gets called by the Composer at the end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding testing comment to bugs for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
                <span class="n">bug</span><span class="o">.</span><span class="n">testing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_bugs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding stable comment to bugs for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
                    <span class="n">bug</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span><span class="p">:</span>
                    <span class="c1"># Only close the tracking bugs</span>
                    <span class="c1"># https://github.com/fedora-infra/bodhi/issues/368#issuecomment-135155215</span>
                    <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bug</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing tracker bug </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span>
                            <span class="n">bug</span><span class="o">.</span><span class="n">close_bug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">:</span>
                        <span class="n">bug</span><span class="o">.</span><span class="n">close_bug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Update.status_comment"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.status_comment">[docs]</a>    <span class="k">def</span> <span class="nf">status_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a comment to this update about a change in status.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;This update has been pushed to stable.&#39;</span><span class="p">,</span>
                         <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;This update has been pushed to testing.&#39;</span><span class="p">,</span>
                         <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;This update has been obsoleted.&#39;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Update.send_update_notice"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.send_update_notice">[docs]</a>    <span class="k">def</span> <span class="nf">send_update_notice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send e-mail notices about this update.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending update notice for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">mailinglist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bodhi_email&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sender</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">((</span><span class="s2">&quot;bodhi_email not defined in configuration!  Unable &quot;</span>
                      <span class="s2">&quot;to send update notice&quot;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># eg: fedora_epel</span>
        <span class="n">release_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">id_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="n">mailinglist</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_announce_list&#39;</span> <span class="o">%</span> <span class="n">release_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="n">mailinglist</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_test_announce_list&#39;</span> <span class="o">%</span> <span class="n">release_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mailinglist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">mail_template</span><span class="p">):</span>
                <span class="n">mail</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">mailinglist</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">errata_schemas</span><span class="o">.</span><span class="n">ErrataPublishV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot find mailing list address for update notice&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;release_name = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">release_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Update.get_url"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the relative URL to this update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;updates&#39;</span><span class="p">]</span>
        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Update.abs_url"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.abs_url">[docs]</a>    <span class="k">def</span> <span class="nf">abs_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the absolute URL to this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (pyramid.request.Request or None): The current web request. Unused.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_address&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">())</span></div>

    <span class="n">url</span> <span class="o">=</span> <span class="n">abs_url</span>

<div class="viewcode-block" id="Update.__str__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation of this update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">initial_indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">subsequent_indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)),</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    Release: </span><span class="si">%s</span>
<span class="s2">     Status: </span><span class="si">%s</span>
<span class="s2">       Type: </span><span class="si">%s</span>
<span class="s2">   Severity: </span><span class="si">%s</span>
<span class="s2">      Karma: </span><span class="si">%d</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Critpath: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Request: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">description</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">:</span>
            <span class="n">bugs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bugstring</span><span class="p">(</span><span class="n">show_titles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       Bugs: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bugs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">67</span><span class="p">,</span> <span class="n">subsequent_indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      Notes: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Submitter: </span><span class="si">%s</span>
<span class="s2">  Submitted: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_submitted</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments_since_karma_reset</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;   Comments: &quot;</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments_since_karma_reset</span><span class="p">:</span>
                <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2"> (karma </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">13</span><span class="p">,</span>
                                <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">comment</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                                <span class="n">comment</span><span class="o">.</span><span class="n">karma</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">initial_indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">13</span><span class="p">,</span>
                                <span class="n">subsequent_indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">13</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">67</span><span class="p">)</span>
                    <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_url</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Update.update_bugs"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.update_bugs">[docs]</a>    <span class="k">def</span> <span class="nf">update_bugs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bug_ids</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the update&#39;s bugs consistent with the given list of bug ids.</span>

<span class="sd">        Create any new bugs, and remove any missing ones. Destroy removed bugs that are no longer</span>
<span class="sd">        referenced anymore. If any associated bug is found to be a security bug, alter the update to</span>
<span class="sd">        be a security update.</span>

<span class="sd">        Args:</span>
<span class="sd">            bug_ids (list): A list of strings of bug ids to associate with this update.</span>
<span class="sd">            session (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: :class:`Bugs &lt;Bug&gt;` that are newly associated with the update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">bug</span> <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span> <span class="k">if</span> <span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bug_ids</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bug</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bug</span><span class="o">.</span><span class="n">updates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Don&#39;t delete the Bug instance if there is any associated BugKarma</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BugKarma</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">bug_id</span><span class="o">=</span><span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Destroying stray Bugzilla #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bug_id</span> <span class="ow">in</span> <span class="n">bug_ids</span><span class="p">:</span>
            <span class="n">bug</span> <span class="o">=</span> <span class="n">Bug</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bug_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bug</span><span class="p">:</span>
                <span class="n">bug</span> <span class="o">=</span> <span class="n">Bug</span><span class="p">(</span><span class="n">bug_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">bug_id</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bug</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bugs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span>
                <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bug</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bug</span><span class="o">.</span><span class="n">security</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span>

        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="Update.obsolete_if_unstable"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.obsolete_if_unstable">[docs]</a>    <span class="k">def</span> <span class="nf">obsolete_if_unstable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obsolete the update if it reached the negative karma threshold while pending.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autokarma</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span>\
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unstable_karma</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has reached unstable karma thresholds&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been obsoleted.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Update.comment"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.comment">[docs]</a>    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">karma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">karma_critpath</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">bug_feedback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">testcase_feedback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_karma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">email_notification</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a comment to this update.</span>

<span class="sd">        If the karma reaches the &#39;stable_karma&#39; value, then request that this update be marked</span>
<span class="sd">        as stable. If it reaches the &#39;unstable_karma&#39;, it is unpushed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">author</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must provide a comment author&#39;</span><span class="p">)</span>

        <span class="c1"># Listify these</span>
        <span class="n">bug_feedback</span> <span class="o">=</span> <span class="n">bug_feedback</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">testcase_feedback</span> <span class="o">=</span> <span class="n">testcase_feedback</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="n">got_feedback</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">feedback_dict</span> <span class="ow">in</span> <span class="p">(</span><span class="n">bug_feedback</span> <span class="o">+</span> <span class="n">testcase_feedback</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">feedback_dict</span><span class="p">[</span><span class="s1">&#39;karma&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">got_feedback</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">text</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">karma</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">karma_critpath</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">got_feedback</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must provide either some text or feedback&#39;</span><span class="p">)</span>

        <span class="n">caveats</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">author</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">karma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">karma</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">notice</span> <span class="o">=</span> <span class="s1">&#39;You may not give karma to your own updates.&#39;</span>
                <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;karma&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">notice</span><span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">author</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">karma</span><span class="o">=</span><span class="n">karma</span><span class="p">,</span> <span class="n">karma_critpath</span><span class="o">=</span><span class="n">karma_critpath</span><span class="p">,</span>
                          <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">karma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Determine whether this user has already left karma, and if so what the most recent</span>
            <span class="c1"># karma value they left was. We should examine all but the most recent comment, since</span>
            <span class="c1"># that is the comment we just added.</span>
            <span class="n">previous_karma</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">author</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">karma</span><span class="p">:</span>
                    <span class="n">previous_karma</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">karma</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">previous_karma</span> <span class="ow">and</span> <span class="n">karma</span> <span class="o">!=</span> <span class="n">previous_karma</span><span class="p">:</span>
                <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;karma&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Your karma standing was reversed.&#39;</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ignoring duplicate </span><span class="si">%d</span><span class="s1"> karma from </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">karma</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated </span><span class="si">%s</span><span class="s2"> karma to </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">check_karma</span> <span class="ow">and</span> <span class="n">author</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system_users&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_karma_thresholds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">LockedUpdateException</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">except</span> <span class="n">BodhiException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># This gets thrown if the karma is pushed over the</span>
                    <span class="c1"># threshold, but it is a critpath update that is not</span>
                    <span class="c1"># critpath_approved. ... among other cases.</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Problem checking the karma threshold.&#39;</span><span class="p">)</span>
                    <span class="n">caveats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;karma&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">})</span>

            <span class="c1"># Obsolete pending update if it reaches unstable karma threshold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsolete_if_unstable</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">feedback_dict</span> <span class="ow">in</span> <span class="n">bug_feedback</span><span class="p">:</span>
            <span class="n">feedback</span> <span class="o">=</span> <span class="n">BugKarma</span><span class="p">(</span><span class="o">**</span><span class="n">feedback_dict</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">bug_feedback</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">feedback_dict</span> <span class="ow">in</span> <span class="n">testcase_feedback</span><span class="p">:</span>
            <span class="n">feedback</span> <span class="o">=</span> <span class="n">TestCaseKarma</span><span class="p">(</span><span class="o">**</span><span class="n">feedback_dict</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">testcase_feedback</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>

        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Publish to Fedora Messaging</span>
        <span class="k">if</span> <span class="n">author</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system_users&#39;</span><span class="p">):</span>
            <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateCommentV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">__json__</span><span class="p">(),</span> <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="n">author</span><span class="p">}))</span>

        <span class="c1"># Send a notification to everyone that has commented on this update</span>
        <span class="n">people</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_maintainers</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                <span class="n">people</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">people</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span> <span class="s1">&#39;bodhi&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                <span class="n">people</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">people</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">email_notification</span><span class="p">:</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">author</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comment</span><span class="p">,</span> <span class="n">caveats</span></div>

<div class="viewcode-block" id="Update.unpush"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.unpush">[docs]</a>    <span class="k">def</span> <span class="nf">unpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move this update back to its dist-fX-updates-candidate tag.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">        Raises:</span>
<span class="sd">            BodhiException: If the update isn&#39;t in testing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unpushing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">koji</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">unpushed</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> already unpushed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t unpush a </span><span class="si">%s</span><span class="s2"> update&quot;</span>
                                 <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">untag</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">preserve_override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">koji</span><span class="o">.</span><span class="n">multicall</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="n">koji</span><span class="o">.</span><span class="n">tagBuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span><span class="p">,</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">koji</span><span class="o">.</span><span class="n">multiCall</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pushed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">unpushed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Update.revoke"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.revoke">[docs]</a>    <span class="k">def</span> <span class="nf">revoke</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove pending request for this update.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BodhiException: If the update doesn&#39;t have a request set, or if it is not in an expected</span>
<span class="sd">                status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Revoking </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span>
                <span class="s2">&quot;Can only revoke an update with an existing request&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">,</span>
                               <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">obsolete</span><span class="p">,</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">unpushed</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">BodhiException</span><span class="p">(</span>
                <span class="s2">&quot;Can only revoke a pending, testing, unpushed, or obsolete &quot;</span>
                <span class="s2">&quot;update, not one that is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># Remove the &#39;pending&#39; koji tags from this update so taskotron stops</span>
        <span class="c1"># evaluating them.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_signing_tag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_testing_tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">pending_stable_tag</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Update.untag"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.untag">[docs]</a>    <span class="k">def</span> <span class="nf">untag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">preserve_override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Untag all of the :class:`Builds &lt;Build&gt;` in this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">            preserve_override: whether to preserve the override tag or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Untagging </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">koji</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="n">tag_types</span><span class="p">,</span> <span class="n">tag_rels</span> <span class="o">=</span> <span class="n">Release</span><span class="o">.</span><span class="n">get_tags</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">koji</span><span class="o">.</span><span class="n">multicall</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">build</span><span class="o">.</span><span class="n">get_tags</span><span class="p">():</span>
                <span class="c1"># Only remove tags that we know about</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_rels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">preserve_override</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">override_tag</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping override tag&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">koji</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping tag that we don&#39;t know about: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
        <span class="n">koji</span><span class="o">.</span><span class="n">multiCall</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pushed</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Update.obsolete"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.obsolete">[docs]</a>    <span class="k">def</span> <span class="nf">obsolete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">newer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obsolete this update.</span>

<span class="sd">        Even though unpushing/obsoletion is an &quot;instant&quot; action, changes in the repository will not</span>
<span class="sd">        propagate until the next compose takes place.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">            newer (Update or None): If given, the update that has obsoleted this one. Defaults to</span>
<span class="sd">                ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Obsoleting </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untag</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">obsolete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">newer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;This update has been obsoleted by [</span><span class="si">%s</span><span class="s2">](</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">newer</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">newer</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">abs_url</span><span class="p">()),</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;This update has been obsoleted.&quot;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Update.get_maintainers"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.get_maintainers">[docs]</a>    <span class="k">def</span> <span class="nf">get_maintainers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of maintainers who have commit access on the packages in this update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of :class:`Users &lt;User&gt;` who have commit access to all of the</span>
<span class="sd">                packages that are contained within this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">product_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string of the product version that this update&#39;s release is associated with.</span>

<span class="sd">        The product version is a string, such as &quot;fedora-26&quot;, and is used when querying Greenwave</span>
<span class="sd">        for test gating decisions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The product version associated with this Update&#39;s Release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">long_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Update.check_requirements"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.check_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">check_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that an update meets its self-prescribed policy to be pushed.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (sqlalchemy.orm.session.Session): A database session. Unused.</span>
<span class="sd">            settings (bodhi.server.config.BodhiConfig): Bodhi&#39;s settings.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing (result, reason) where result is a bool</span>
<span class="sd">                and reason is a str.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_passed</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Required tests did not pass on this update&quot;</span><span class="p">)</span>

        <span class="n">requirements</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requirements</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;No checks required.&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># https://github.com/fedora-infra/bodhi/issues/362</span>
            <span class="n">since</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to determine last_modified from </span><span class="si">%r</span><span class="s2"> : </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to determine last_modified: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># query results for this update</span>
            <span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;bodhi_update&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="n">since</span><span class="p">,</span>
                         <span class="n">testcases</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">requirements</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">taskotron_results</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">))</span>

            <span class="c1"># query results for each build</span>
            <span class="c1"># retrieve timestamp for each build so that queries can be optimized</span>
            <span class="n">koji</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
            <span class="n">koji</span><span class="o">.</span><span class="n">multicall</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
                <span class="n">koji</span><span class="o">.</span><span class="n">getBuild</span><span class="p">(</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
            <span class="n">buildinfos</span> <span class="o">=</span> <span class="n">koji</span><span class="o">.</span><span class="n">multiCall</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">build</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">):</span>
                <span class="n">multicall_response</span> <span class="o">=</span> <span class="n">buildinfos</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">multicall_response</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">multicall_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Error retrieving data from Koji for </span><span class="si">%r</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">multicall_response</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">buildinfo</span> <span class="o">=</span> <span class="n">multicall_response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">buildinfo</span><span class="p">[</span><span class="s1">&#39;completion_ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

                <span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;koji_build&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span>
                             <span class="n">testcases</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">requirements</span><span class="p">))</span>
                <span class="n">build_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">taskotron_results</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">))</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">build_results</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed retrieving requirements results: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed retrieving requirements results: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">testcase</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="n">relevant</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;testcase&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">testcase</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">relevant</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;No result found for required testcase </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">testcase</span>

            <span class="n">by_arch</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">relevant</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;noarch&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">by_arch</span><span class="p">[</span><span class="n">arch</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">arch</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">by_arch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">latest</span> <span class="o">=</span> <span class="n">relevant</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># resultsdb results are ordered chronologically</span>
                <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;outcome&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PASSED&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Required task </span><span class="si">%s</span><span class="s2"> returned </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;testcase&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;outcome&#39;</span><span class="p">])</span>

        <span class="c1"># TODO - check require_bugs and require_testcases also?</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;All checks pass.&quot;</span></div>

<div class="viewcode-block" id="Update.check_karma_thresholds"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.check_karma_thresholds">[docs]</a>    <span class="k">def</span> <span class="nf">check_karma_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if we have reached either karma threshold, and adjust state as necessary.</span>

<span class="sd">        This method will call :meth:`set_request` if necessary. If the update is locked, it will</span>
<span class="sd">        ignore karma thresholds and raise an Exception.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session.</span>
<span class="sd">            agent (str): The username of the user who has provided karma.</span>
<span class="sd">        Raises:</span>
<span class="sd">            LockedUpdateException: If the update is locked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Raise Exception if the update is locked</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> locked. Ignoring karma thresholds.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">LockedUpdateException</span>
        <span class="c1"># Return if the status of the update is not in testing or pending</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">,</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># Also return if the status of the update is not in testing and the release is frozen</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ReleaseState</span><span class="o">.</span><span class="n">frozen</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># If an update receives negative karma disable autopush</span>
        <span class="c1"># exclude rawhide updates see #4566</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autokarma</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">autotime</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composite_karma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> \
                <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disabling Auto Push since the update has received negative karma&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autokarma</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autotime</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disable_automatic_push_to_stable&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;bodhi&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_karma</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_karma</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">composed_by_bodhi</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_passed</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> reached stable karma threshold, but does not meet gating &quot;</span>
                         <span class="s2">&quot;requirements&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_approved</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autokarma</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Automatically marking </span><span class="si">%s</span><span class="s2"> as stable&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_request</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
                <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateKarmaThresholdV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;stable&#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add the stable approval message now</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">((</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> update has reached the stable karma threshold and can be pushed to &quot;</span>
                    <span class="s2">&quot;stable now if the maintainer wishes&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unstable_karma</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unstable_karma</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">pending</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autokarma</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Automatically unpushing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateKarmaThresholdV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unstable&#39;</span><span class="p">)))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">builds_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON representation of this update&#39;s associated builds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A JSON list of the :class:`Builds &lt;Build&gt;` associated with this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span> <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requirements_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON representation of this update&#39;s requirements.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A JSON representation of this update&#39;s requirements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requirements</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the last time this update was edited or created.</span>

<span class="sd">        This gets used specifically by taskotron/resultsdb queries so we only</span>
<span class="sd">        query for test runs that occur *after* the last time this update</span>
<span class="sd">        (in its current form) was in play.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.datetime: The most recent time of modification or creation.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the update has no timestamps set, which should not be possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prune out None values that have not been set</span>
        <span class="n">possibilities</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">date_submitted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_modified</span><span class="p">]</span>
        <span class="n">possibilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">possibilities</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">possibilities</span><span class="p">:</span>  <span class="c1"># Should be un-possible.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Update has no timestamps set: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">possibilities</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort smallest to largest (oldest to newest)</span>
        <span class="k">return</span> <span class="n">possibilities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Return the last one</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">critpath_approved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether or not this critpath update has been approved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if this update meets critpath testing requirements, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://fedorahosted.org/bodhi/ticket/642</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meets_testing_requirements</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">min_karma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">critpath_min_karma</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">setting_status</span><span class="p">:</span>
            <span class="n">num_admin_approvals</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">setting_prefix</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">setting_status</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="s1">&#39;.critpath.num_admin_approvals&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_admin_approvals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">min_karma</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_admin_approvals</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_admin_approvals</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;=</span> <span class="n">min_karma</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_admin_approvals</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;critpath.num_admin_approvals&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;=</span> <span class="n">min_karma</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meets_testing_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether or not this update meets its release&#39;s testing requirements.</span>

<span class="sd">        If this update&#39;s release does not have a mandatory testing requirement, then</span>
<span class="sd">        simply return True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the update meets testing requirements, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_gating.required&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_gating_passed</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">critpath_min_karma</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">critpath</span><span class="p">:</span>
            <span class="c1"># Ensure there is no negative karma. We&#39;re looking at the sum of</span>
            <span class="c1"># each users karma for this update, which takes into account</span>
            <span class="c1"># changed votes.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composite_karma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_in_testing</span> <span class="o">&gt;=</span> <span class="n">num_days</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_days</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_karma</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Any update that reaches num_days has met the testing requirements.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_in_testing</span> <span class="o">&gt;=</span> <span class="n">num_days</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_stable_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether Bodhi has commented on the update that the requirements have been met.</span>

<span class="sd">        This is used to determine whether bodhi should add the comment</span>
<span class="sd">        about the Update&#39;s eligibility to be pushed, as we only want Bodhi</span>
<span class="sd">        to add the comment once.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: See description above for what the bool might mean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments_since_karma_reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;bodhi&#39;</span> <span class="ow">and</span> \
               <span class="n">comment</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;testing_approval_msg&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">days_to_stable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of days until an update can be pushed to stable.</span>

<span class="sd">        This method will return the number of days until an update can be pushed to stable, or 0.</span>
<span class="sd">        0 is returned if the update meets testing requirements already, if it doesn&#39;t have a</span>
<span class="sd">        &quot;truthy&quot; date_testing attribute, or if it&#39;s been in testing for the release&#39;s</span>
<span class="sd">        mandatory_days_in_testing or longer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of dates until this update can be pushed to stable, or 0 if it cannot be</span>
<span class="sd">                determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">meets_testing_requirements</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_testing</span><span class="p">:</span>
            <span class="n">num_days</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mandatory_days_in_testing</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_in_testing</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">num_days</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">days_in_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of days that this update has been in testing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of days since this update&#39;s date_testing if it is set, else 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_testing</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_testing</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_admin_approvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of Releng/QA approvals of this update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of admin approvals found in the comments of this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">approvals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments_since_karma_reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment</span><span class="o">.</span><span class="n">karma</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">admin_groups</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;admin_groups&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">admin_groups</span><span class="p">:</span>
                    <span class="n">approvals</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">approvals</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">test_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of all TestCase names associated with all packages in this update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of strings naming the :class:`TestCases &lt;TestCase&gt;` associated with</span>
<span class="sd">                this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">build</span><span class="o">.</span><span class="n">testcases</span><span class="p">:</span>
                <span class="n">tests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tests</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_test_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of all TestCases associated with all packages in this update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of :class:`TestCases &lt;TestCase&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="n">test_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">build</span><span class="o">.</span><span class="n">testcases</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">test_names</span><span class="p">:</span>
                    <span class="n">test_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">tests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tests</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">testcase</span><span class="p">:</span> <span class="n">testcase</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requested_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the tag the update has requested.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The Koji tag that corresponds to the update&#39;s current request.</span>
<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If a Koji tag is unable to be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">stable_tag</span>
            <span class="c1"># [No Frozen Rawhide] Move stable builds going to a pending</span>
            <span class="c1"># release to the Release.dist-tag</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">state</span> <span class="ow">is</span> <span class="n">ReleaseState</span><span class="o">.</span><span class="n">pending</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">dist_tag</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">testing_tag</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">candidate_tag</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Unable to determine requested tag for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tag</span>

<div class="viewcode-block" id="Update.__json__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.__json__">[docs]</a>    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON representation of this update.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (pyramid.request.Request or None): The current web request,</span>
<span class="sd">                or None. Passed on to :meth:`BodhiBase.__json__`.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A JSON representation of this update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Update</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__json__</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># Duplicate alias as updateid for backwards compat with bodhi1</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;updateid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span>
        <span class="c1"># Include the karma total in the results</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;karma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span>
        <span class="c1"># Also, the Update content_type (derived from the builds content_types)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># For https://github.com/fedora-infra/bodhi/issues/270, throw the JSON</span>
        <span class="c1"># of the test cases in our output as well but take extra care to</span>
        <span class="c1"># short-circuit some of the insane recursion for</span>
        <span class="c1"># https://github.com/fedora-infra/bodhi/issues/343</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[</span><span class="n">Package</span><span class="p">,</span> <span class="n">TestCaseKarma</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;test_cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">test</span><span class="o">.</span><span class="n">_to_json</span><span class="p">(</span>
                <span class="n">obj</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
                <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span>
                <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_test_cases</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Update.comment_on_test_gating_status_change"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Update.comment_on_test_gating_status_change">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">comment_on_test_gating_status_change</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">initiator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Place comment on the update when ``test_gating_status`` changes.</span>

<span class="sd">        Only notify the users by email if the new status is in ``failed``.</span>

<span class="sd">        Args:</span>
<span class="sd">            target (InstanceState): The state of the instance that has had a</span>
<span class="sd">                change to its test_gating_status attribute.</span>
<span class="sd">            value (EnumSymbol): The new value of the test_gating_status.</span>
<span class="sd">            old (EnumSymbol): The old value of the test_gating_status</span>
<span class="sd">            initiator (sqlalchemy.orm.attributes.Event): The event object that is initiating this</span>
<span class="sd">                transition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">object</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">notify</span> <span class="o">=</span> <span class="n">value</span> <span class="o">==</span> <span class="n">TestGatingStatus</span><span class="o">.</span><span class="n">failed</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;This update&#39;s test gating status has been changed to &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
                <span class="n">author</span><span class="o">=</span><span class="s2">&quot;bodhi&quot;</span><span class="p">,</span>
                <span class="n">email_notification</span><span class="o">=</span><span class="n">notify</span><span class="p">,</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_build_group_test_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="s2">&quot;bodhi&quot;</span><span class="p">,</span> <span class="n">retrigger</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the dictionary sent when an update is ready to be tested.</span>

<span class="sd">        This is used in bodhi.server.models.Update._ready_for_testing and in</span>
<span class="sd">        bodhi.server.services.updates.trigger_tests which are the two places</span>
<span class="sd">        where we send notifications about an update being ready to be tested</span>
<span class="sd">        by any CI system.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (str): For the case where the message is sent as a test</span>
<span class="sd">                re-trigger request, the user who requested it. Otherwise,</span>
<span class="sd">                &#39;bodhi&#39;.</span>
<span class="sd">            retrigger (bool): Whether the message is sent as a test re-</span>
<span class="sd">                trigger request.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary corresponding to the message sent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contact</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bodhi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;admin@fp.o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;team&quot;</span><span class="p">:</span> <span class="s2">&quot;Fedora CI&quot;</span><span class="p">,</span>
            <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="s2">&quot;https://docs.fedoraproject.org/en-US/ci/&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">builds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
            <span class="n">builds</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;koji-build&quot;</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">build</span><span class="o">.</span><span class="n">get_build_id</span><span class="p">(),</span>
                <span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">build</span><span class="o">.</span><span class="n">get_task_id</span><span class="p">(),</span>
                <span class="s2">&quot;issuer&quot;</span><span class="p">:</span> <span class="n">build</span><span class="o">.</span><span class="n">get_owner_name</span><span class="p">(),</span>
                <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr_name</span><span class="p">,</span>
                <span class="s2">&quot;nvr&quot;</span><span class="p">:</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span>
                <span class="s2">&quot;scratch&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="n">artifact</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;koji-build-group&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;repository&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_url</span><span class="p">(),</span>
            <span class="s2">&quot;builds&quot;</span><span class="p">:</span> <span class="n">builds</span><span class="p">,</span>
            <span class="s2">&quot;release&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">dist_tag</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;contact&quot;</span><span class="p">:</span> <span class="n">contact</span><span class="p">,</span>
            <span class="s2">&quot;artifact&quot;</span><span class="p">:</span> <span class="n">artifact</span><span class="p">,</span>
            <span class="s2">&quot;update&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;generated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.2.2&quot;</span><span class="p">,</span>
            <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="n">agent</span><span class="p">,</span>
            <span class="s1">&#39;re-trigger&#39;</span><span class="p">:</span> <span class="n">retrigger</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_ready_for_testing</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">initiator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signal that the update has been moved to testing.</span>

<span class="sd">        This happens in the following cases:</span>
<span class="sd">        - for stable releases: the update lands in the testing repository</span>
<span class="sd">        - for rawhide: all packages in an update have been built by koji</span>

<span class="sd">        Args:</span>
<span class="sd">            target (Update): The update that has had a change to its status attribute.</span>
<span class="sd">            value (EnumSymbol): The new value of Update.status.</span>
<span class="sd">            old (EnumSymbol): The old value of the Update.status</span>
<span class="sd">            initiator (sqlalchemy.orm.attributes.Event): The event object that is initiating this</span>
<span class="sd">                transition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="n">old</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">old</span> <span class="o">==</span> <span class="n">NEVER_SET</span><span class="p">:</span>
            <span class="c1"># This is the object initialization phase. This instance is not ready, don&#39;t create</span>
            <span class="c1"># the message now. This method will be called again at the end of __init__</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">content_type</span> <span class="o">!=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">rpm</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">update_schemas</span><span class="o">.</span><span class="n">UpdateReadyForTestingV2</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">_build_group_test_message</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
    <span class="n">Update</span><span class="o">.</span><span class="n">test_gating_status</span><span class="p">,</span>
    <span class="s1">&#39;set&#39;</span><span class="p">,</span>
    <span class="n">Update</span><span class="o">.</span><span class="n">comment_on_test_gating_status_change</span><span class="p">,</span>
    <span class="n">active_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
    <span class="n">Update</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
    <span class="s1">&#39;set&#39;</span><span class="p">,</span>
    <span class="n">Update</span><span class="o">.</span><span class="n">_ready_for_testing</span><span class="p">,</span>
    <span class="n">active_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="Compose"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Compose">[docs]</a><span class="k">class</span> <span class="nc">Compose</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Express the status of an in-progress compose job.</span>

<span class="sd">    This object is used in a few ways:</span>

<span class="sd">        * It ensures that only one compose process runs per repo, serving as a compose &quot;lock&quot;.</span>
<span class="sd">        * It marks which updates are part of a compose, serving as an update &quot;lock&quot;.</span>
<span class="sd">        * It gives the compose process a place to log which step it is in, which will allow us to</span>
<span class="sd">          provide compose monitoring tools.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        __exclude_columns__ (tuple): A tuple of columns to exclude when __json__() is called.</span>
<span class="sd">        __include_extras__ (tuple): A tuple of attributes to add when __json__() is called.</span>
<span class="sd">        __tablename__ (str): The name of the table in the database.</span>
<span class="sd">        checkpoints (str): A JSON serialized object describing the checkpoints the composer has</span>
<span class="sd">            reached.</span>
<span class="sd">        date_created (datetime.datetime): The time this Compose was created.</span>
<span class="sd">        error_message (str): An error message indicating what happened if the Compose failed.</span>
<span class="sd">        release_id (int): The primary key of the :class:`Release` that is being composed. Forms half</span>
<span class="sd">            of the primary key, with the other half being the ``request``.</span>
<span class="sd">        request (UpdateRequest): The request of the release that is being composed. Forms half of</span>
<span class="sd">            the primary key, with the other half being the ``release_id``.</span>
<span class="sd">        release (Release): The release that is being composed.</span>
<span class="sd">        state_date (datetime.datetime): The time of the most recent change to the state attribute.</span>
<span class="sd">        state (ComposeState): The state of the compose.</span>
<span class="sd">        updates (sqlalchemy.orm.collections.InstrumentedList): An iterable of updates included in</span>
<span class="sd">            this compose.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;updates&#39;</span><span class="p">)</span>
    <span class="c1"># We need to include content_type and security so the composer can collate the Composes and so</span>
    <span class="c1"># it can pick the right composer class to use.</span>
    <span class="n">__include_extras__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span> <span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="s1">&#39;update_summary&#39;</span><span class="p">)</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;composes&#39;</span>

    <span class="c1"># These together form the primary key.</span>
    <span class="n">release_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;releases.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UpdateRequest</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># The parent class gives us an id primary key, but we&#39;d rather have a &quot;natural&quot; primary key, so</span>
    <span class="c1"># let&#39;s override it and set to None.</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># We could use the JSON type here, but that would require PostgreSQL &gt;= 9.2.0. We don&#39;t really</span>
    <span class="c1"># need the ability to query inside this so the JSONB type probably isn&#39;t useful.</span>
    <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">)</span>
    <span class="n">date_created</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="n">state_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">release</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Release&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;composes&#39;</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ComposeState</span><span class="o">.</span><span class="n">db_type</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ComposeState</span><span class="o">.</span><span class="n">requested</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the content_type of this compose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (ContentType or None): The content type of this compose, or None if there are no</span>
<span class="sd">                associated :class:`Updates &lt;Update&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content_type</span>

<div class="viewcode-block" id="Compose.from_dict"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Compose.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">compose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a :class:`Compose` instance from the given dict representation of it.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (sqlalchemy.orm.session.Session): A database session to use to query for the compose.</span>
<span class="sd">            compose (dict): A dictionary representing the compose, in the format returned by</span>
<span class="sd">                :meth:`Compose.__json__`.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bodhi.server.models.Compose: The requested compose instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">release_id</span><span class="o">=</span><span class="n">compose</span><span class="p">[</span><span class="s1">&#39;release_id&#39;</span><span class="p">],</span>
            <span class="n">request</span><span class="o">=</span><span class="n">UpdateRequest</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">compose</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">one</span><span class="p">()</span></div>

<div class="viewcode-block" id="Compose.from_updates"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Compose.from_updates">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_updates</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of Compose objects to compose the given updates.</span>

<span class="sd">        The updates will be collated by release, request, and content type, and will be added to</span>
<span class="sd">        new Compose objects that match those groupings.</span>

<span class="sd">        Note that calling this will cause each of the updates to become locked once the transaction</span>
<span class="sd">        is committed.</span>

<span class="sd">        Args:</span>
<span class="sd">            updates (list): A list of :class:`Updates &lt;Update&gt;` that you wish to Compose.</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: A list of new compose objects for the given updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="o">.</span><span class="n">request</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> request was revoked&#39;</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># ASSUMPTION: For now, updates can only be of a single type.</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No builds in </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">update</span><span class="o">.</span><span class="n">builds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ctype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ctype</span> <span class="o">=</span> <span class="n">build</span><span class="o">.</span><span class="n">type</span>
                <span class="k">elif</span> <span class="n">ctype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">build</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="c1"># This branch is not covered because the Update.validate_builds validator</span>
                    <span class="c1"># catches the same assumption breakage. This check here is extra for the</span>
                    <span class="c1"># time when someone adds multitype updates and forgets to update this.</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Builds of multiple types found in </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># This key is just to insert things in the same place in the &quot;work&quot;</span>
            <span class="c1"># dict.</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">work</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">release_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                <span class="n">release</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
            <span class="c1"># Lock the Update. This implicitly adds it to the Compose because the Update.compose</span>
            <span class="c1"># relationship joins on the Compose&#39;s compound pk for locked Updates.</span>
            <span class="n">update</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># We cast to a list here because a dictionary&#39;s values() method does not return a list in</span>
        <span class="c1"># Python 3 and the docblock states that a list is returned.</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">security</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether this compose is a security related compose or not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if any of the :class:`Updates &lt;Update&gt;` in this compose are marked as</span>
<span class="sd">                security updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Compose.update_state_date"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Compose.update_state_date">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_state_date</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">initiator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the ``state_date`` when the state changes.</span>

<span class="sd">        Args:</span>
<span class="sd">            target (Compose): The compose that has had a change to its state attribute.</span>
<span class="sd">            value (EnumSymbol): The new value of the state.</span>
<span class="sd">            old (EnumSymbol): The old value of the state</span>
<span class="sd">            initiator (sqlalchemy.orm.attributes.Event): The event object that is initiating this</span>
<span class="sd">                transition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">state_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">update_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a summary of the updates attribute, suitable for transmitting via the API.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of dictionaries with keys &#39;alias&#39; and &#39;title&#39;, indexing each update alias</span>
<span class="sd">                and title associated with this Compose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">get_title</span><span class="p">(</span><span class="n">nvr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">beautify</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">]</span>

<div class="viewcode-block" id="Compose.__json__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Compose.__json__">[docs]</a>    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">composer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize this compose in JSON format.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (pyramid.request.Request or None): The current web request, or None.</span>
<span class="sd">            exclude (iterable or None): See superclass docblock.</span>
<span class="sd">            include (iterable or None): See superclass docblock.</span>
<span class="sd">            composer (bool): If True, increase the number of excluded attributes so that only the</span>
<span class="sd">                attributes required by the Composer to identify Composes are included. Defaults to</span>
<span class="sd">                False. If used, overrides exclude and include.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A JSON representation of the Compose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">composer</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;checkpoints&#39;</span><span class="p">,</span> <span class="s1">&#39;error_message&#39;</span><span class="p">,</span> <span class="s1">&#39;date_created&#39;</span><span class="p">,</span> <span class="s1">&#39;state_date&#39;</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;updates&#39;</span><span class="p">)</span>
            <span class="c1"># We need to include content_type and security so the composer can collate the Composes</span>
            <span class="c1"># and so it can pick the right composer class to use.</span>
            <span class="n">include</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span> <span class="s1">&#39;security&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Compose</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__json__</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compose.__lt__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Compose.__lt__">[docs]</a>    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return ``True`` if this compose has a higher priority than the other.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (Compose): Another compose we are comparing this compose to for sorting.</span>
<span class="sd">        Return:</span>
<span class="sd">            bool: ``True`` if this compose has a higher priority than the other, else ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">security</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">security</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">request</span> <span class="o">!=</span> <span class="n">UpdateRequest</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Compose.__str__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Compose.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a human-readable representation of this compose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string to be displayed to users describing this compose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Compose: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">description</span><span class="p">)</span></div></div>


<span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">Compose</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="n">Compose</span><span class="o">.</span><span class="n">update_state_date</span><span class="p">,</span> <span class="n">active_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Used for many-to-many relationships between karma and a bug</span>
<div class="viewcode-block" id="BugKarma"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BugKarma">[docs]</a><span class="k">class</span> <span class="nc">BugKarma</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Karma for a bug associated with a comment.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        karma (int): The karma associated with this bug and comment.</span>
<span class="sd">        comment (Comment): The comment this BugKarma is part of.</span>
<span class="sd">        bug (Bug): The bug this BugKarma pertains to.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;comment_bug_assoc&#39;</span>

    <span class="n">karma</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Many-to-one relationships</span>
    <span class="n">comment_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;comments.id&#39;</span><span class="p">))</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Comment&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;bug_feedback&#39;</span><span class="p">,</span>
                                                      <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all,delete,delete-orphan&quot;</span><span class="p">))</span>

    <span class="n">bug_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;bugs.bug_id&#39;</span><span class="p">))</span>
    <span class="n">bug</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Bug&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;feedback&#39;</span><span class="p">)</span></div>


<span class="c1"># Used for many-to-many relationships between karma and a TestCase</span>
<div class="viewcode-block" id="TestCaseKarma"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.TestCaseKarma">[docs]</a><span class="k">class</span> <span class="nc">TestCaseKarma</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Karma for a TestCase associated with a comment.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        karma (int): The karma associated with this TestCase comment.</span>
<span class="sd">        comment (Comment): The comment this TestCaseKarma is associated with.</span>
<span class="sd">        testcase (TestCase): The TestCase this TestCaseKarma pertains to.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;comment_testcase_assoc&#39;</span>

    <span class="n">karma</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Many-to-one relationships</span>
    <span class="n">comment_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;comments.id&#39;</span><span class="p">))</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Comment&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;testcase_feedback&#39;</span><span class="p">,</span>
                                                      <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all,delete,delete-orphan&quot;</span><span class="p">))</span>

    <span class="n">testcase_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;testcases.id&#39;</span><span class="p">))</span>
    <span class="n">testcase</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;TestCase&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;feedback&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Comment"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Comment">[docs]</a><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An update comment.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        karma (int): The karma associated with this comment. Defaults to 0.</span>
<span class="sd">        karma_critpath (int): The critpath karma associated with this comment. Defaults to 0.</span>
<span class="sd">            **DEPRECATED** no longer used in the UI</span>
<span class="sd">        text (str): The text of the comment.</span>
<span class="sd">        timestamp (datetime.datetime): The time the comment was created. Defaults to</span>
<span class="sd">            the return value of datetime.utcnow().</span>
<span class="sd">        update (Update): The update that this comment pertains to.</span>
<span class="sd">        user (User): The user who wrote this comment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;comments&#39;</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,)</span>

    <span class="n">karma</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">karma_critpath</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="c1"># One-to-many relationships</span>
    <span class="c1"># bug_feedback backref from BugKarma</span>
    <span class="c1"># testcase_feedback backref from TestCaseKarma</span>

    <span class="c1"># Many-to-one relationships</span>
    <span class="n">update_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;updates.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># update backref from Update</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># user backref from User</span>

<div class="viewcode-block" id="Comment.url"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Comment.url">[docs]</a>    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a URL to this comment.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A URL to this comment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">get_url</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;#comment-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unique_testcase_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">TestCaseKarma</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of unique :class:`TestCaseKarma` objects found in the testcase_feedback.</span>

<span class="sd">        This will filter out duplicates for :class:`TestCases &lt;TestCase&gt;`. It will return the</span>
<span class="sd">        correct number of TestCases in testcase_feedback as a list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of unique :class:`TestCaseKarma` objects associated with this comment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feedbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testcase_feedback</span>
        <span class="n">unique_feedbacks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">filtered_feedbacks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="n">feedbacks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">testcase</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_feedbacks</span><span class="p">:</span>
                <span class="n">unique_feedbacks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">feedback</span><span class="o">.</span><span class="n">testcase</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">filtered_feedbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_feedbacks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rss_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a formatted title for the comment using update alias and comment id.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A string representation of the comment for RSS feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> comment #</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<div class="viewcode-block" id="Comment.__json__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Comment.__json__">[docs]</a>    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON string representation of this comment.</span>

<span class="sd">        Args:</span>
<span class="sd">            args: A list of extra args to pass on to :meth:`BodhiBase.__json__`.</span>
<span class="sd">            kwargs: Extra kwargs to pass on to :meth:`BodhiBase.__json__`.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A JSON-serializable dict representation of this comment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__json__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Duplicate &#39;user&#39; as &#39;author&#39; just for backwards compat with bodhi1.</span>
        <span class="c1"># Things like the message schemas and fedbadges rely on this.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="c1"># Similarly, duplicate the update&#39;s alias as update_alias.</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;update_alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">][</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span>

        <span class="c1"># Updates used to have a karma column which would be included in result[&#39;update&#39;]. The</span>
        <span class="c1"># column was replaced with a property, so we need to include it here for backwards</span>
        <span class="c1"># compatibility.</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">][</span><span class="s1">&#39;karma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">karma</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Comment.__str__"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Comment.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a str representation of this comment.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A str representation of this comment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">karma</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">karma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">karma</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%+d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">karma</span><span class="p">,)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2"> (karma: </span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">karma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Bug"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Bug">[docs]</a><span class="k">class</span> <span class="nc">Bug</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a Bugzilla bug.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        bug_id (int): The bug&#39;s id.</span>
<span class="sd">        title (str): The description of the bug.</span>
<span class="sd">        security (bool): True if the bug is marked as a security issue.</span>
<span class="sd">        parent (bool): True if this is a parent tracker bug for release-specific bugs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bugs&#39;</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;updates&#39;</span><span class="p">)</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;bug_id&#39;</span><span class="p">,)</span>

    <span class="c1"># Bug number. If None, assume ``url`` points to an external bug tracker</span>
    <span class="n">bug_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The title of the bug</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>

    <span class="c1"># If we&#39;re dealing with a security bug</span>
    <span class="n">security</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># If this bug is a parent tracker bug for release-specific bugs</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Many-to-many relationships</span>
    <span class="c1"># updates backref from Update</span>
    <span class="c1"># feedback backref from BugKarma</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a URL to the bug.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The URL to this bug.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;buglink&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span>

<div class="viewcode-block" id="Bug.update_details"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Bug.update_details">[docs]</a>    <span class="k">def</span> <span class="nf">update_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bug</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;bugzilla.bug.Bug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grab details from rhbz to populate our bug fields.</span>

<span class="sd">        This is typically called &quot;offline&quot; in the UpdatesHandler task.</span>

<span class="sd">        Args:</span>
<span class="sd">            bug: The Bug to retrieve details from Bugzilla about. If</span>
<span class="sd">                 None, self.bug_id will be used to retrieve the bug. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bugs</span><span class="o">.</span><span class="n">bugtracker</span><span class="o">.</span><span class="n">update_details</span><span class="p">(</span><span class="n">bug</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Bug.default_message"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Bug.default_message">[docs]</a>    <span class="k">def</span> <span class="nf">default_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a default comment to add to a bug with add_comment().</span>

<span class="sd">        Args:</span>
<span class="sd">            update: The update that is related to the bug.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The default comment to add to the bug related to the given update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">install_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Soon you</span><span class="se">\&#39;</span><span class="s1">ll be able to install the update with the following &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;command:</span><span class="se">\n</span><span class="s1">`</span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">install_command</span><span class="si">}</span><span class="s1">`&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">install_command</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">msg_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;update_title&#39;</span><span class="p">:</span> <span class="n">update</span><span class="o">.</span><span class="n">get_title</span><span class="p">(</span><span class="n">delim</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="n">nvr</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;update_beauty_title&#39;</span><span class="p">:</span> <span class="n">update</span><span class="o">.</span><span class="n">get_title</span><span class="p">(</span><span class="n">beautify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nvr</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;update_alias&#39;</span><span class="p">:</span> <span class="n">update</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                    <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">long_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;install_instructions&#39;</span><span class="p">:</span> <span class="n">install_msg</span><span class="p">,</span>
                    <span class="s1">&#39;update_url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_address&quot;</span><span class="p">)</span><span class="si">}{</span><span class="n">update</span><span class="o">.</span><span class="n">get_url</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;stable_bug_msg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">msg_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">update</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">id_prefix</span> <span class="o">==</span> <span class="s2">&quot;FEDORA-EPEL&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;testing_bug_epel_msg&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;testing_bug_epel_msg&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;testing_bug_msg&#39;</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No &#39;testing_bug_epel_msg&#39; found in the config.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;testing_bug_msg&#39;</span><span class="p">]</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">msg_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to post a default comment to a bug, but &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s1"> is not in Stable or Testing status.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span></div>

<div class="viewcode-block" id="Bug.add_comment"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Bug.add_comment">[docs]</a>    <span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a comment to the bug, pertaining to the given update.</span>

<span class="sd">        Args:</span>
<span class="sd">            update: The update that is related to the bug.</span>
<span class="sd">            comment: The comment to add to the bug. If None, a default message</span>
<span class="sd">                is added to the bug. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> \
                <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">stable</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not commenting on parent security bug </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_message</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding comment to Bug #</span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">))</span>
            <span class="n">bugs</span><span class="o">.</span><span class="n">bugtracker</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span></div>

<div class="viewcode-block" id="Bug.testing"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Bug.testing">[docs]</a>    <span class="k">def</span> <span class="nf">testing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the status of this bug to ON_QA.</span>

<span class="sd">        Also, comment on the bug with some details on how to test and provide feedback for the given</span>
<span class="sd">        update.</span>

<span class="sd">        Args:</span>
<span class="sd">            update: The update associated with the bug.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Skip modifying Security Response bugs for testing updates</span>
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not modifying parent security bug </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_message</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
            <span class="n">bugs</span><span class="o">.</span><span class="n">bugtracker</span><span class="o">.</span><span class="n">on_qa</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span></div>

<div class="viewcode-block" id="Bug.close_bug"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Bug.close_bug">[docs]</a>    <span class="k">def</span> <span class="nf">close_bug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the bug.</span>

<span class="sd">        Args:</span>
<span class="sd">            update: The update associated with the bug.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build a mapping of package names to build versions</span>
        <span class="c1"># so that .close() can figure out which build version fixes which bug.</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
            <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">nvr_name</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">update</span><span class="o">.</span><span class="n">builds</span>
        <span class="p">])</span>
        <span class="n">bugs</span><span class="o">.</span><span class="n">bugtracker</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_message</span><span class="p">(</span><span class="n">update</span><span class="p">))</span></div>

<div class="viewcode-block" id="Bug.modified"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Bug.modified">[docs]</a>    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the status of this bug to MODIFIED unless it is a parent security bug.</span>

<span class="sd">        Also, comment on the bug stating that an update has been submitted.</span>

<span class="sd">        Args:</span>
<span class="sd">            update: The update that is associated with this bug.</span>
<span class="sd">            comment: A comment to leave on the bug when modifying it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">UpdateType</span><span class="o">.</span><span class="n">security</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not modifying parent security bug </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bugs</span><span class="o">.</span><span class="n">bugtracker</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bug_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span></div></div>


<span class="n">user_group_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;user_group_table&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                         <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">)),</span>
                         <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;groups.id&#39;</span><span class="p">)))</span>


<div class="viewcode-block" id="User"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.User">[docs]</a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Bodhi user.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The username.</span>
<span class="sd">        email (str): An e-mail address for the user.</span>
<span class="sd">        comments (sqlalchemy.orm.dynamic.AppenderQuery): An iterable of :class:`Comments &lt;Comment&gt;`</span>
<span class="sd">            the user has written.</span>
<span class="sd">        updates (sqlalchemy.orm.dynamic.AppenderQuery): An iterable of :class:`Updates &lt;Update&gt;` the</span>
<span class="sd">            user has created.</span>
<span class="sd">        groups (sqlalchemy.orm.collections.InstrumentedList): An iterable of :class:`Groups &lt;Group&gt;`</span>
<span class="sd">            the user is a member of.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;updates&#39;</span><span class="p">,</span> <span class="s1">&#39;buildroot_overrides&#39;</span><span class="p">)</span>
    <span class="n">__include_extras__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;avatar&#39;</span><span class="p">,</span> <span class="s1">&#39;openid&#39;</span><span class="p">)</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">)</span>

    <span class="c1"># One-to-many relationships</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Update</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
    <span class="c1"># buildroot_overrides backref from BuildrootOverride</span>

    <span class="c1"># Many-to-many relationships</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">user_group_table</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;users&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="User.avatar"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.User.avatar">[docs]</a>    <span class="k">def</span> <span class="nf">avatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s1">&#39;pyramid.request&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a URL for the User&#39;s avatar, or None if request is falsey.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The current web request.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A URL for the User&#39;s avatar, or None if request is falsey.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_avatar</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span></div>

<div class="viewcode-block" id="User.openid"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.User.openid">[docs]</a>    <span class="k">def</span> <span class="nf">openid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s1">&#39;pyramid.request&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an openid identity URL.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The current web request.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The openid identity URL for the User object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openid_template&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Group"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.Group">[docs]</a><span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A group of users.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of the Group.</span>
<span class="sd">        users (sqlalchemy.orm.collections.InstrumentedList): An iterable of the</span>
<span class="sd">            :class:`Users &lt;User&gt;` who are in the group.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;groups&#39;</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
    <span class="n">__exclude_columns__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="c1"># Many-to-many relationships</span>
    <span class="c1"># users backref from User</span>


<div class="viewcode-block" id="BuildrootOverride"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BuildrootOverride">[docs]</a><span class="k">class</span> <span class="nc">BuildrootOverride</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model represents a Koji buildroot override.</span>

<span class="sd">    A buildroot override is a way to add a build to the Koji buildroot (the set of packages used</span>
<span class="sd">    to build a package) manually. Normally, builds are only available after they are pushed to</span>
<span class="sd">    &quot;stable&quot;, but this allows a build to be added to the buildroot immediately. This is useful</span>
<span class="sd">    for updates that depend on each other to be built.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        notes (str): A text field that holds arbitrary notes about the buildroot override.</span>
<span class="sd">        submission_date (DateTime): The date that the buildroot override was submitted.</span>
<span class="sd">        expiration_date (DateTime): The date that the buildroot override expires.</span>
<span class="sd">        expired_date (DateTime): The date that the buildroot override expired.</span>
<span class="sd">        build_id (int): The primary key of the :class:`Build` this override is related to.</span>
<span class="sd">        build (Build): The build this override is related to.</span>
<span class="sd">        submitter_id (int): The primary key of the :class:`User` this override was created by.</span>
<span class="sd">        submitter (User): The user this override was created by.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;buildroot_overrides&#39;</span>
    <span class="n">__include_extras__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nvr&#39;</span><span class="p">,)</span>
    <span class="n">__get_by__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;build_id&#39;</span><span class="p">,)</span>

    <span class="n">notes</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">submission_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">expiration_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">expired_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">)</span>

    <span class="c1"># Many-to-one relationships</span>
    <span class="n">build_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;builds.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">build</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">submitter_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">submitter</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;buildroot_overrides&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the NVR of the :class:`Build` associated with this override.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The override&#39;s :class:`Build&#39;s &lt;Build&gt;` NVR.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span>

<div class="viewcode-block" id="BuildrootOverride.new"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BuildrootOverride.new">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s1">&#39;pyramid.request&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuildrootOverride&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new buildroot override.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The current web request.</span>
<span class="sd">            data: A dictionary of all the attributes to be used on the new override.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The newly created BuildrootOverride instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span>

        <span class="n">build</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">build</span><span class="o">.</span><span class="n">override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;nvr&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is already in a override&#39;</span> <span class="o">%</span> <span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">old_build</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Build</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">Build</span><span class="o">.</span><span class="n">package_id</span> <span class="o">==</span> <span class="n">build</span><span class="o">.</span><span class="n">package_id</span><span class="p">,</span>
                <span class="n">Build</span><span class="o">.</span><span class="n">release_id</span> <span class="o">==</span> <span class="n">build</span><span class="o">.</span><span class="n">release_id</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">old_build</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old_build</span><span class="o">.</span><span class="n">override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># There already is a buildroot override for an older build of this</span>
            <span class="c1"># package in this release. Expire it</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expiring BRO for </span><span class="si">{</span><span class="n">old_build</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s2"> because it&#39;s superseded by </span><span class="si">{</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">old_build</span><span class="o">.</span><span class="n">override</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">old_build</span><span class="o">.</span><span class="n">override</span><span class="p">)</span>

        <span class="n">override</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="n">override</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">override</span></div>

<div class="viewcode-block" id="BuildrootOverride.edit"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BuildrootOverride.edit">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s1">&#39;pyramid.request&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuildrootOverride&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Edit an existing buildroot override.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The current web request.</span>
<span class="sd">            data: The changed being made to the BuildrootOverride.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The new updated override.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span>
        <span class="n">edited</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;edited&#39;</span><span class="p">)</span>
        <span class="n">override</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edited</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">override</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;edited&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;No buildroot override for this build&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">override</span><span class="o">.</span><span class="n">submitter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;submitter&#39;</span><span class="p">]</span>
        <span class="n">override</span><span class="o">.</span><span class="n">notes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span>
        <span class="n">override</span><span class="o">.</span><span class="n">expiration_date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;expiration_date&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;submission_date&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">override</span><span class="o">.</span><span class="n">submission_date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;submission_date&#39;</span><span class="p">]</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">override</span><span class="o">.</span><span class="n">expired_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">override</span><span class="o">.</span><span class="n">expiration_date</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
            <span class="c1"># Buildroot override had expired, we need to unexpire it</span>
            <span class="n">override</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;expired&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expiring BRO for </span><span class="si">{</span><span class="n">override</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="si">}</span><span class="s2"> because it was edited.&quot;</span><span class="p">)</span>
            <span class="n">override</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">override</span></div>

<div class="viewcode-block" id="BuildrootOverride.enable"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BuildrootOverride.enable">[docs]</a>    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark the BuildrootOverride as enabled.&quot;&quot;&quot;</span>
        <span class="n">koji_session</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="n">koji_session</span><span class="o">.</span><span class="n">tagBuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">override_tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">)</span>

        <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">override_schemas</span><span class="o">.</span><span class="n">BuildrootOverrideTagV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="bp">self</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expired_date</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BuildrootOverride.expire"><a class="viewcode-back" href="../../../developer/docblocks/bodhi.server.models.html#bodhi.server.models.BuildrootOverride.expire">[docs]</a>    <span class="k">def</span> <span class="nf">expire</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark the BuildrootOverride as expired.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">koji_session</span> <span class="o">=</span> <span class="n">buildsys</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">koji_session</span><span class="o">.</span><span class="n">untagBuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">override_tag</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to untag override </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nvr</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expired_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="n">notifications</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">override_schemas</span><span class="o">.</span><span class="n">BuildrootOverrideUntagV1</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;override&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">}))</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
    
    <h1 class="logo logo-name">bodhi</h1>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=fedora-infra&repo=bodhi&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/testing.html">Testing updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/update_states.html">Update states</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/buildroot_overrides.html">Buildroot Overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/automatic_updates.html">Automatic Updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/fedora-flavored-markdown.html">Fedora-Flavored Markdown</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/release_notes.html">Release notes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../server_api/index.html">Bodhi Server APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python_bindings.html">Python bindings</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/releases.html">Release process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/vagrant.html">Vagrant</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/vagrant_vscode.html">Debugging with Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/virtualenv.html">Virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/models.html">Database models</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../administration.html">Administration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2007-2023, Red Hat, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>